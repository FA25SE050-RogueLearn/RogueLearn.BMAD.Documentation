# **Story 2.2: Backend - Generate QuestLine from Curriculum**

## Status

Draft

## Ownership

*   **Primary Owner:** An (Backend)
*   **Supporting:** Minh Anh (Backend)
*   **Rationale:** This task involves generating the core gamified content (quests) based on the foundational academic data. It is a core backend task suitable for the main backend team.

## Story

**As a** Game Master (Admin),
**I want** to trigger the generation of a QuestLine from a pre-existing curriculum version via an API endpoint,
**so that** the system can transform the academic blueprint into an interactive learning path for students.

## Acceptance Criteria

1. A new `POST /api/admin/quest-lines/generate-from-curriculum` endpoint is created in the `QuestsService`.
2. The endpoint accepts a JSON body containing a `curriculumVersionId`.
3. The service fetches the full curriculum structure (including subjects and terms) from the `UserService` using the provided `curriculumVersionId`.
4. If the curriculum version is found, the service generates the corresponding `LearningPath` (QuestLine), `Quests`, and `QuestSteps` in its own database.
5. The endpoint returns the ID of the newly created `LearningPath`.
6. If the `curriculumVersionId` is invalid or not found, the endpoint returns a `404 Not Found`.
7. The endpoint is protected and only accessible by users with the 'Admin' role.

## Tasks / Subtasks

- [ ] **Task 1: Create the QuestLine Generation API Endpoint** (AC: #1, #7)
    - [ ] In the `QuestsService`, create a new `QuestLinesAdminController`.
    - [ ] Implement the `POST /api/admin/quest-lines/generate-from-curriculum` endpoint.
    - [ ] Secure the endpoint with the `[Authorize(Roles = "Admin")]` attribute.
- [ ] **Task 2: Implement Internal API Client for UserService** (AC: #3)
    - [ ] In the `QuestsService`, create a typed HTTP client or service to communicate with the `UserService`.
    - [ ] Implement a method to fetch the curriculum structure by its version ID (e.g., `GET /api/internal/curriculum-versions/{versionId}`).
- [ ] **Task 3: Implement QuestLine Generation Logic** (AC: #4)
    - [ ] In the Application layer of `QuestsService`, create a `GenerateQuestLineFromCurriculumCommand`.
    - [ ] The handler for this command will:
        - [ ] Call the `UserService` client to get the curriculum data.
        - [ ] If not found, return a `404` error (AC: #6).
        - [ ] If found, iterate through the subjects and terms to create `LearningPath` and `Quest` entities.
- [ ] **Task 4: Return Response** (AC: #5)
    - [ ] Ensure the controller returns a `201 Created` status with the new `LearningPath` ID upon success.
- [ ] **Task 5: Write Integration Tests**
    - [ ] Write tests to verify that a valid `curriculumVersionId` successfully creates a complete and correctly structured `LearningPath`.
    - [ ] Write tests to verify that an invalid ID returns a `404` error.
    - [ ] Write tests to verify that a non-admin user receives a `403 Forbidden` error.

## Dev Notes

### **Architectural Guidance**
*   This refactored story now correctly aligns with the microservice architecture. The `QuestsService` is now a **consumer** of academic data, not its owner.
*   **Responsibility**: The `QuestsService` is responsible for the **transformation** of a static curriculum into a dynamic, gamified `LearningPath` (QuestLine).
*   **Inter-Service Communication**: This story introduces the first critical **internal API call** from one service (`QuestsService`) to another (`UserService`). This call should be secured (e.g., using a shared secret or client credentials) and resilient (e.g., using Polly for retries).

### **Data Flow**
1.  Admin provides a `curriculumVersionId` to the `QuestsService`.
2.  `QuestsService` calls `UserService` to get all details for that curriculum.
3.  `UserService` returns the structured data (subjects, terms, etc.).
4.  `QuestsService` uses this data to populate its own tables (`learning_paths`, `quests`).

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| [Current Date] | 1.1 | Refactored story to align with microservice principles. Changed from "import" to "generate from curriculum ID". | BMad Orchestrator |
| [Current Date] | 1.0 | Story redefined to focus on manual JSON import, deferring automated scraping and AI. | Winston, Architect |
