# docs/stories/2.4.integration-codebattle-api.md
# **Story 2.4: Integration - Expose Code Battle Problems API**

## Status


Move to the next sprint

## Ownership

*   **Primary Owner:** Phuc (Code Battle Service)
*   **Rationale:** Phuc has ownership of the Code Battle service. This story involves creating the API layer for his existing work, making him the ideal owner.

## Story

**As a** Developer,
**I want** a secure API endpoint to retrieve a list of available code problems,
**so that** I can display them in the frontend and integrate them into quests later.

## Acceptance Criteria

1.  A new `GET /api/code-problems` endpoint is created in the Go-based `roguelearn-code-battle-service`.
2.  The endpoint retrieves and returns a list of `CodeProblem` entities from its database.
3.  The endpoint is protected and requires a valid Supabase JWT, consistent with the .NET services.
4.  The response format is a standard JSON array.
5.  Basic pagination (e.g., `?page=1&limit=20`) is implemented.

## Tasks / Subtasks

- [ ] **Task 1: Create API Endpoint Handler** (AC: #1)
    - [ ] In the Go service, set up a new router and handler for `GET /api/code-problems`.
- [ ] **Task 2: Implement JWT Validation Middleware** (AC: #3)
    - [ ] Create middleware for the Go HTTP server that validates Supabase JWTs. This must be compatible with the keys/secrets used by the .NET services.
    - [ ] Apply this middleware to the new endpoint.
- [ ] **Task 3: Implement Database Logic** (AC: #2, #5)
    - [ ] Implement the function to query the `code_problems` table from the PostgreSQL database.
    - [ ] Add support for `page` and `limit` query parameters.
- [ ] **Task 4: Write Integration Tests**
    - [ ] Write tests for the new endpoint.
    - [ ] Include a test case for an unauthenticated request to ensure it returns a `401 Unauthorized` or `403 Forbidden` error.
    - [ ] Include a test case with a valid JWT to verify successful data retrieval.

## Dev Notes

### **Driving Requirement**
This is the first step in integrating the "somewhat complete" Code Battle service into the main application, aligning with **FR43 (Code Battle System)**. This story focuses on creating the first read-only "on-ramp" to the service's data.

*Source: `docs/prd/requirements.md`*

### **Architectural Guidance**
*   **Repository**: This work is within the **`roguelearn-code-battle-service`** repository.
*   **API Consistency**: It is critical that the JWT validation logic and response structures are consistent with the main .NET API. The Supabase JWT Secret must be securely shared (e.g., via environment variables) between the .NET and Go services. Collaboration with the .NET backend team (An/Minh Anh) is required to ensure compatibility.
*   **Database**: The service should connect to the same PostgreSQL instance used by the .NET services, but it will only access its own dedicated tables (`code_problems`, `submissions`, etc.).

*Source: `docs/service-databases/code-battle-service-database.md`*

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| [Current Date] | 1.0 | Initial story draft. | BMad Orchestrator |

## Dev Agent Record

### Agent Model Used
_TBD by Dev Agent_

### Debug Log References
_TBD by Dev Agent_

### Completion Notes List
_TBD by Dev Agent_

### File List
_TBD by Dev Agent_

## QA Results
_TBD by QA Agent_
