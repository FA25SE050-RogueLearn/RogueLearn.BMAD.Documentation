# **Story 2.2: Backend - Manual Curriculum JSON Import and QuestLine Generation**

## Status

Draft

## Ownership

*   **Primary Owner:** Minh Anh (Backend)
*   **Supporting:** An (Backend)
*   **Rationale:** This combines the data processing and quest generation logic into a single, straightforward backend task, making it a good fit for the core backend team.

## Story

**As a** Game Master (Admin),
**I want** to upload a pre-formatted JSON file containing curriculum data via an API endpoint,
**so that** the system can process it and automatically generate a new QuestLine.

## Acceptance Criteria

1. A new `POST /api/admin/curriculum/import` endpoint is created in the `QuestsService`.
2. The endpoint accepts a file upload (specifically, a `.json` file).
3. The service parses the JSON file, validating it against a predefined structure.
4. If validation passes, the service uses the data to create the corresponding `QuestLine`, `QuestChapters`, and `Quests` in the database, ordered by term/semester.
5. The endpoint returns the ID of the newly created `QuestLine`.
6. If the JSON is malformed or fails validation, the endpoint returns a `400 Bad Request` with clear error messages.
7. The endpoint is protected and only accessible by users with the 'Admin' role.

## Tasks / Subtasks

- [ ] **Task 1: Define the Curriculum JSON Schema**
    - [ ] In the `BuildingBlocks.Shared` project, create C# classes that define the expected structure of the curriculum JSON file.
- [ ] **Task 2: Create the Import API Endpoint** (AC: #1, #2, #7)
    - [ ] In the `QuestsService`, create a new `CurriculumImportController`.
    - [ ] Implement the `POST /api/admin/curriculum/import` endpoint to handle a file upload.
    - [ ] Secure the endpoint with the `[Authorize(Roles = "Admin")]` attribute.
- [ ] **Task 3: Implement Parsing and Validation Logic** (AC: #3, #6)
    - [ ] In the Application layer, create a `ImportCurriculumFromJsonCommand`.
    - [ ] The handler for this command will be responsible for reading the uploaded file stream, deserializing it into the C# model, and validating its structure and content.
- [ ] **Task 4: Implement QuestLine Generation Logic** (AC: #4)
    - [ ] Create a `QuestGenerationService` that takes the validated curriculum data as input.
    - [ ] This service will contain the logic to create the `QuestLine`, `QuestChapters`, and `Quest` entities based on the imported data. This re-incorporates the logic from the original, deleted Story 2.2.
- [ ] **Task 5: Return Response** (AC: #5)
    - [ ] Ensure the controller returns a `21 Created` status with the new `QuestLine` ID upon success.
- [ ] **Task 6: Write Integration Tests**
    - [ ] Write tests to verify that a valid JSON file successfully creates a complete and correctly structured QuestLine.
    - [ ] Write tests to verify that invalid or malformed JSON files return appropriate `400` errors.

## Dev Notes

### **Architectural Guidance**
*   This story provides a manual on-ramp for curriculum data, decoupling us from the complexities of web scraping and AI for the MVP.
*   **Responsibility**: The `QuestsService` will own this entire workflow. It will not need to communicate with any other new services for this task.
*   **Human-in-the-Loop**: The "human" part of this loop is now at the very beginning: the Admin is responsible for preparing the clean JSON file. This simplifies the backend logic significantly.

### **Example JSON Structure to Support**
The system should expect a JSON file with the following structure. This should be formally defined in the C# models.

```json
{
  "curriculumCode": "BIT_SE_K19D_K20A",
  "name": "The Bachelor Program of Information Technology, Software Engineering Major",
  "programLearningOutcomes": [
    { "code": "PLO1", "description": "..." }
  ],
  "subjects": [
    {
      "code": "PRF192",
      "name": "Programming Fundamentals",
      "semester": 1,
      "credits": 3,
      "prerequisites": null
    },
    {
      "code": "PRO192",
      "name": "Object-Oriented Programming",
      "semester": 2,
      "credits": 3,
      "prerequisites": "Pass PRF192"
    }
  ]
}
```

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| [Current Date] | 1.0 | Story redefined to focus on manual JSON import, deferring automated scraping and AI. | Winston, Architect |
