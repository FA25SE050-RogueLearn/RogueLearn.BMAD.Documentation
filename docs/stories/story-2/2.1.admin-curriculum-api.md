# docs/stories/2.1.admin-curriculum-api.md
# **Story 2.1: Admin - Curriculum Management Foundation**

## Status

Approved

## Ownership

*   **Primary Owner:** An (Backend)
*   **Supporting:** Minh Anh (Backend/CI-CD)
*   **Rationale:** As a core fullstack developer, An is well-suited to build this foundational backend API. Minh Anh can provide support and ensure the service integrates with the CI/CD pipeline she is managing.

## Story

**As a** Game Master (Admin),
**I want** to create and manage the core academic structures like Programs, Subjects, and Curriculum Versions via API endpoints,
**so that** I can provide the foundational data required for the student onboarding process and quest generation.

## Acceptance Criteria

1.  A set of protected API endpoints are created that are only accessible by users with the 'Admin' role ('Game Master').
2.  An admin can create, read, update, and delete `curriculum_programs` (e.g., "Bachelor of Software Engineering").
3.  An admin can create, read, update, and delete `subjects` (e.g., "PRF192 - Programming Fundamentals").
4.  An admin can create and manage `curriculum_versions` for a specific program (e.g., "K18A," "2024-Catalog").
5.  An admin can associate subjects with a specific curriculum version, defining the `curriculum_structure` (e.g., add "PRF192" to the "K18A" version for term 1).
6.  All API endpoints must enforce role-based access control (RBAC), returning a `403 Forbidden` error if accessed by a non-admin user.
7.  The implementation must include xUnit integration tests to verify the functionality and security of each new endpoint.

## Tasks / Subtasks

- [ ] **Task 1: Implement Role-Based Authorization** (AC: #1, #6)
    - [ ] In the `roguelearn-api` solution, create or enhance a shared authorization handler/policy that checks if the authenticated user's JWT contains the 'Admin' role claim.
- [ ] **Task 2: Create Endpoints for Curriculum Programs** (AC: #2)
    - [ ] In the `UserService`, create a new `CurriculumProgramsController`.
    - [ ] Implement `GET /api/admin/curriculum-programs` to list all programs.
    - [ ] Implement `POST /api/admin/curriculum-programs` to create a new program.
    - [ ] Implement `PUT /api/admin/curriculum-programs/{id}` to update a program.
    - [ ] Implement `DELETE /api/admin/curriculum-programs/{id}` to delete a program.
    - [ ] Secure all endpoints with the 'Admin' role policy.
- [ ] **Task 3: Create Endpoints for Subjects** (AC: #3)
    - [ ] In the `UserService`, create a new `SubjectsController`.
    - [ ] Implement `GET /api/admin/subjects` and `POST /api/admin/subjects` (and optional PUT/DELETE).
    - [ ] Secure all endpoints with the 'Admin' role policy.
- [ ] **Task 4: Create Endpoints for Curriculum Versions & Structure** (AC: #4, #5)
    - [ ] In a new `CurriculumVersionsController`, implement endpoints to manage versions for a given program (e.g., `GET /api/admin/curriculum-programs/{programId}/versions`).
    - [ ] Implement an endpoint to associate subjects with a version, creating records in the `curriculum_structure` table (e.g., `POST /api/admin/curriculum-versions/{versionId}/subjects`).
    - [ ] Secure all endpoints with the 'Admin' role policy.
- [ ] **Task 5: Write Integration Tests** (AC: #7)
    - [ ] Create a new test suite for all the admin curriculum endpoints.
    - [ ] Write tests to verify that an admin user can successfully perform all CRUD operations.
    - [ ] Write tests to verify that a non-admin user receives a `403 Forbidden` error when attempting to access any of these endpoints.

- [ ] **Task 6: AI-Powered Curriculum/Syllabus Import (Manual Text) via Semantic Kernel** (FR53)
    - [ ] Implement `POST /api/admin/curriculum/import/text` accepting raw FLM text pasted by the Game Master.
    - [ ] Add Semantic Kernel packages to the solution: `Microsoft.SemanticKernel` and (if using agents) `Microsoft.SemanticKernel.Agents.Core`. Configure connectors for Azure OpenAI or OpenAI using environment variables like `AZURE_OPENAI_*` or `OPENAI_API_KEY` [0].
    - [ ] Create an SK plugin/function (e.g., `CurriculumExtractor`) with prompt templates that normalize FLM text into structured JSON aligned with `extracted-data/` (e.g., `curriculum/*.json`, `syllabus/*.json`).
    - [ ] Use SK’s structured output capabilities to enforce the JSON shape for programs, subjects, versions, structure mapping, and syllabi where applicable [0]. Validate and handle malformed outputs.
    - [ ] Return the processed JSON in the response and make it available for downstream persistence.
    - [ ] Enforce the 'Admin' role policy on this endpoint.

- [ ] **Task 7: Define JSON Schema & Validation for Import**
    - [ ] Specify the JSON structure expected for programs, subjects, curriculum versions, curriculum structure, and syllabus details (patterned after files in `extracted-data/`).
    - [ ] Validate AI output against the schema; provide actionable validation errors.
    - [ ] Include safeguards for missing fields, inconsistent codes, and term/semester mappings.

- [ ] **Task 8: Implement CQRS Commands & Handlers for Persistence**
    - [ ] Create commands and handlers to persist imported data: programs, subjects, curriculum versions, curriculum structure associations, and syllabus entries.
    - [ ] Ensure idempotency/deduplication using natural keys (e.g., subject code, program code, version label) to avoid duplicate records across imports.
    - [ ] Add query handlers to retrieve the imported entities for admin verification.

- [ ] **Task 9: Orchestrate Import Flow in Backend**
    - [ ] Implement an orchestration handler/service that: calls SK extractor → validates JSON → dispatches CQRS commands to store data → aggregates results.
    - [ ] Provide audit logs and metrics for imported item counts and any failures.
    - [ ] Add error handling and partial failure reporting (e.g., when some subjects fail validation).

- [ ] **Task 11: Semantic Kernel Configuration & Observability**
    - [ ] Centralize SK kernel configuration, model selection, retry policies, and logging.
    - [ ] Support switching between Azure OpenAI, OpenAI, and local providers (e.g., Ollama/LMStudio) for development flexibility [0].
    - [ ] Document required environment variables and secrets management for deployment.

- [ ] **Task 10: Extend Integration Tests for Import Flow** (AC: #7)
    - [ ] Add tests that simulate an admin pasting raw FLM text and verify JSON transformation.
    - [ ] Add tests for schema validation failures and success cases.
    - [ ] Add tests for CQRS persistence, including idempotent re-import behavior.
    - [ ] Verify non-admin access receives `403 Forbidden` for the import endpoint.

## Dev Notes

### **Driving Requirement**
This story directly implements the foundational backend capabilities outlined in **FR53 (Admin-Owned University Curriculum Import & Administration)**. The focus is on creating the manual API endpoints first, which will be used by an admin UI in the future.

*Source: `docs/prd/requirements.md`*

### **Architectural Guidance**
*   **Repository**: All work for this story will be done within the **`roguelearn-api`** .NET solution. This is a backend-only story.
*   **Service**: The logical location for these academic structure endpoints is the **`UserService`**, as it owns the core user profile and their associated academic context.
*   **Database Tables**: This story will involve creating C# Entity Framework models and performing CRUD operations on the following tables: `curriculum_programs`, `subjects`, `curriculum_versions`, and `curriculum_structure`.

*Source: `docs/fullstack-architecture/database-schema.md`*

### **API Specification**
*   The endpoints created should follow the patterns defined in the OpenAPI specification for the admin-level endpoints. For example: `POST /admin/curriculum/import`, `GET /admin/curriculum/versions`, etc. Please adhere to this convention.
*   **Security**: This is the first story to implement true role-based access. The JWT validation middleware from Story 1.2 should be extended to check for a specific role claim (e.g., `"role": "Admin"`). All endpoints in the new admin controllers must be decorated with `[Authorize(Roles = "Admin")]`.

*Source: `docs/fullstack-architecture/api-specification.md`*

### **AI Import Flow**
*   **Input**: The Game Master pastes raw text from the university FLM into the admin import endpoint.
*   **Processing**: Semantic Kernel orchestrates AI parsing and normalization of the text into JSON following the patterns demonstrated in `extracted-data/`.
*   **Output**: JSON containing programs, subjects, versions, structure mappings (term/semester), and syllabus details where applicable.
*   **Persistence**: The backend orchestrator validates the JSON against the schema and uses CQRS commands to persist entities with idempotency.

### **CQRS Persistence**
*   **Commands**: Separate commands for creating/upserting programs, subjects, versions, structure associations, and syllabi.
*   **Handlers**: Focused handlers that enforce validation and deduplication based on natural keys (e.g., `subjectCode`, `programCode`, `versionLabel`).
*   **Queries**: Admin-facing queries to verify imported data and support onboarding flow population.
*   **Idempotency**: Re-imports should not create duplicates; they should update/merge as appropriate.

### **Semantic Kernel Integration Notes**
*   **Model Flexibility**: SK is model-agnostic and supports Azure OpenAI, OpenAI, Hugging Face, NVidia, and local deployments (Ollama, LMStudio) [0].
*   **Agents & Plugins**: Build modular extraction logic as SK plugins or agents with tool functions and prompt templates [0].
*   **Structured Output**: Leverage SK’s structured output support to constrain responses to the expected JSON schema [0].
*   **Setup**: Add `Microsoft.SemanticKernel` (and optionally `Microsoft.SemanticKernel.Agents.Core`) via NuGet. Configure providers using environment variables (`AZURE_OPENAI_*` or `OPENAI_API_KEY`) [0].
*   **Observability**: Utilize SK’s enterprise-ready reliability and logging hooks to monitor extraction quality and failures [0].

### **Prerequisite for Onboarding**
Completing this story is a **blocker** for the user-facing onboarding story. The `GET` endpoints created here will be consumed by the onboarding wizard to populate the dropdowns for "Route" selection.

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| [Current Date] | 1.0 | Initial story draft, focusing on admin-first backend capabilities. | BMad Orchestrator |

## Dev Agent Record

### Agent Model Used
_TBD by Dev Agent_

### Debug Log References
_TBD by Dev Agent_

### Completion Notes List
_TBD by Dev Agent_

### File List
_TBD by Dev Agent_

## QA Results
_TBD by QA Agent_