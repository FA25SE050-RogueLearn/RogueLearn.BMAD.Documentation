# **Story 2.5: Integration - Migrate to Multiplayer Unity Boss Fight**

## Status

In Progress

## Ownership

*   **Primary Owners:** Tan (Unity) & Duong (Frontend)
*   **Rationale:** This is an integration story requiring close collaboration. Tan is responsible for the Unity build and exposing the communication bridge. Duong is responsible for embedding the client in the Next.js application and handling the events.

## Story

**As a** Player,
**I want** to be able to launch and play a multiplayer "Boss Fight" from a dedicated page in the web app,
**so that** the core gamified assessment experience is integrated into the platform and I can play with others.

## Acceptance Criteria

1.  A stable WebGL build of the **multiplayer** "Boss Fight" experience is provided by the Unity developer, using **Unity Gaming Services (UGS) for networking**.
2.  A new page is created in the Next.js app at the route `/boss-fight-arena`.
3.  The page uses the `react-unity-webgl` library to embed the Unity client.
4.  A "Launch Game" button on the page successfully initializes and displays the Unity game.
5.  The Unity game, upon completion, uses a JavaScript bridge (`Application.ExternalCall`) to send a "GameOver" event with a final score back to the React component.
6.  The React component listens for the "GameOver" event and displays the final score on the web page below the game canvas.

## Tasks / Subtasks

- [x] **Task 0 (Unity): Create Single-Player Game Loop**
    - [x] A functional single-player version of the boss fight was created as a prototype.
- [ ] **Task 1 (Unity): Migrate to Multiplayer using UGS**
    - [ ] Refactor the existing single-player logic to support a multiplayer environment.
    - [ ] Integrate Unity Gaming Services for matchmaking, networking, and session management.
- [ ] **Task 2 (Unity): Expose Communication Function** (AC: #5)
    - [ ] In the Unity project, create a C# script that calls `Application.ExternalCall("GameOver", score)` when the boss fight ends.
- [ ] **Task 3 (Unity): Create WebGL Build** (AC: #1)
    - [ ] Generate a clean WebGL build and place the output files in the `public/unity/` directory of the `roguelearn-web` project.
- [ ] **Task 4 (Frontend): Create Arena Page** (AC: #2)
    - [ ] Create the new route file at `src/app/boss-fight-arena/page.tsx`.
- [ ] **Task 5 (Frontend): Implement Unity Embedding Component** (AC: #3, #4)
    - [ ] Install the `react-unity-webgl` library.
    - [ ] Create a new component (`UnityGameEmbed.tsx`) that configures and renders the `<Unity>` component, pointing to the build files in `/public/unity/`.
    - [ ] Add a button to the arena page that mounts and displays this component.
- [ ] **Task 6 (Frontend): Implement Event Listener** (AC: #5, #6)
    - [ ] In the `UnityGameEmbed` component, use the `useUnityContext` hook to set up an event listener for the "GameOver" event.
    - [ ] When the event is received, update the component's state to display the score received from the game.
- [ ] **Task 7: Write Tests**
    - [ ] Write a component test for the `UnityGameEmbed` component to ensure it renders correctly.
    - [ ] Manually test the end-to-end flow to confirm the event bridge is working.

## Dev Notes

### **Driving Requirement**
This story implements the client-side portion of **FR16 (Gamified Mock Exams)** and is the first technical integration of the Unity client into the web platform.

*Source: `docs/prd/requirements.md`*

### **Architectural Guidance**
*   **Repositories**: This story involves collaboration across two repos: **`roguelearn-unity-games`** (for the build) and **`roguelearn-web`** (for the embedding).
*   **Integration Pattern**: The `react-unity-webgl` library is the specified tool for this integration. The communication pattern is a one-way bridge from Unity to React for this story.
*   **File Placement**: For simplicity in this initial story, the Unity build files will be placed directly in the `public/` folder of the Next.js project. In the future, these will be hosted on a CDN.

*Source: `docs/fullstack-architecture/frontend-architecture.md`, `docs/fullstack-architecture/unity-architecture.md`*

### **Scope Limitation**
This story is strictly about the **technical integration** of embedding the game and receiving a result. Triggering the game from a specific quest and persisting the score to the backend are out of scope and will be handled in a subsequent story.

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| [Current Date] | 1.0 | Initial story draft. | BMad Orchestrator |
| 2025-10-13 | 1.1 | Updated story to reflect the migration to a multiplayer experience using Unity Gaming Services. | Tan(Ryan) |

## Dev Agent Record

### Agent Model Used
_TBD by Dev Agent_

### Debug Log References
_TBD by Dev Agent_

### Completion Notes List
_TBD by Dev Agent_

### File List
_TBD by Dev Agent_

## QA Results
_TBD by QA Agent_