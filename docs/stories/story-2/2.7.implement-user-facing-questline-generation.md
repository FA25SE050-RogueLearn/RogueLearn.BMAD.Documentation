// RougeLearn.BMAD.Documentation/docs/stories/story-2/2.7.implement-user-facing-questline-generation.md
# **Story 2.7: Implement User-Facing QuestLine Generation from Uploaded Content**

## Status

Approved

## Ownership

*   **Primary Owner:** An (Backend)
*   **Supporting:** Minh Anh (Backend)
*   **Rationale:** This feature extends the core quest generation logic owned by the `QuestsService`. It requires reusing the generation engine from Story 2.6 but wrapping it in a new user-facing API.

## Story

**As a** Player,
**I want** to upload my own curriculum file (e.g., a syllabus) and have the system generate a personal QuestLine from it,
**so that** I can use RogueLearn even if my university's curriculum is not pre-loaded by an admin.

## Acceptance Criteria

1.  A new API endpoint, `POST /api/me/quest-lines/generate-from-upload`, is created in the `QuestsService`.
2.  The endpoint accepts a file upload (e.g., PDF, DOCX, TXT) and is protected, requiring standard user authentication.
3.  The service uses the `AIProxyService` to parse the uploaded file and extract a structured curriculum format (similar to the DTO used in Story 2.2).
4.  The extracted data is then passed to the core `QuestGenerationService` (developed in Story 2.6) to create the `LearningPath`, `QuestChapters`, and `Quests`.
5.  The newly created `LearningPath` is marked as `is_published = false` to indicate it is a personal, user-generated path.
6.  Upon successful creation of the `LearningPath`, a new record is immediately created in the `user_learning_path_progress` table, linking the `auth_user_id` of the current user to the new `learning_path_id`.
7.  The endpoint returns the ID of the newly created `LearningPath`.
8.  The endpoint returns a `400 Bad Request` if the file is invalid or cannot be parsed.
9.  The implementation includes integration tests to verify the end-to-end flow, including the creation of the `user_learning_path_progress` record.

## Tasks / Subtasks

- [ ] **Task 1: Create User-Facing API Endpoint** (AC: #1, #2)
    - [ ] In the `QuestsService`, create a new `MyQuestLinesController` at the route `api/me/quest-lines`.
    - [ ] Implement the `POST /generate-from-upload` endpoint to handle a file upload (`IFormFile`).
    - [ ] Secure the endpoint with a standard `[Authorize]` attribute (no admin role required).
- [ ] **Task 2: Implement CQRS for Personal Generation** (AC: #3)
    - [ ] In the Application layer, create a `GeneratePersonalQuestLineCommand` that includes the file stream and the user's `auth_user_id`.
    - [ ] The handler for this command will orchestrate the process.
- [ ] **Task 3: Implement AI Parsing Logic** (AC: #3)
    - [ ] In the command handler, create a call to the `AIProxyService` (via an internal API client).
    - [ ] This call will pass the file content and request it to be parsed into the standard `CurriculumDto`.
- [ ] **Task 4: Reuse Core Generation Logic** (AC: #4, #5)
    - [ ] The command handler, upon receiving the structured `CurriculumDto` from the `AIProxyService`, will call the existing `QuestGenerationService` (from Story 2.6) to create the entities.
    - [ ] Ensure the created `LearningPath` has its `is_published` flag set to `false`.
- [ ] **Task 5: Link QuestLine to User** (AC: #6)
    - [ ] After the `LearningPath` is created, the command handler must create and persist a `UserLearningPathProgress` entity.
    - [ ] This new entity links the `auth_user_id` (from the JWT) to the new `LearningPath.Id`.
- [ ] **Task 6: Write Integration Tests** (AC: #9)
    - [ ] Write tests simulating a user uploading a valid file and verify that both the `LearningPath` and the `UserLearningPathProgress` records are created correctly.
    - [ ] Write a test to ensure `is_published` is `false`.
    - [ ] Write a test to verify that an unauthenticated request returns a `401 Unauthorized`.

## Dev Notes

### **Driving Requirement**
This story directly enables the user-driven workflow described in **FR2** and **FR22**. It provides the backend functionality that the browser extension will eventually call to allow any user to bring their own curriculum into the RogueLearn ecosystem.

### **Architectural Guidance**
*   **Code Reusability:** This story is a prime example of reusing core logic. The heavy lifting of quest generation should already be implemented in a `QuestGenerationService` as part of Story 2.6. This story's main task is to create a new entry point that uses AI to prepare the data *before* feeding it to that existing service.
*   **Distinction from Admin Flow:** It is critical that this flow is kept separate from the admin flow. The endpoint is different (`/api/me/...` vs. `/api/admin/...`), the authentication is different (standard user vs. admin), and the output is different (a personal, non-published `LearningPath` that is immediately assigned to the user).
*   **AI Service Dependency:** This workflow introduces a dependency on the `AIProxyService` to act as the parser for unstructured user content. The communication between `QuestsService` and `AIProxyService` should be via a secure, internal API call.

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| [Current Date] | 1.0 | Initial story draft to enable user-driven, personalized QuestLine generation. | BMad Orchestrator |