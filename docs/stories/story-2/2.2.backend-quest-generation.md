# docs/stories/2.2.backend-quest-generation.md
# **Story 2.2: Backend - Initial Quest Generation from Curriculum**

## Status

Draft

## Ownership

*   **Primary Owner:** Minh Anh (Backend)
*   **Supporting:** An (Backend)
*   **Rationale:** Minh Anh, as the other fullstack developer, can work on this service in parallel with Story 2.1. This task involves inter-service communication, which is a key fullstack responsibility.

## Story

**As a** System,
**I want** to process a stored Curriculum Version and its subjects,
**so that** I can automatically generate a basic, sequential QuestLine for a student.

## Acceptance Criteria

1.  A new endpoint is created in the `QuestsService` (e.g., `POST /api/quest-lines/generate-from-curriculum`).
2.  This endpoint accepts a `curriculum_version_id` and a `user_id`.
3.  The service fetches the `curriculum_structure` for the given version from the `UserService` via an internal API call or direct DB query if appropriate.
4.  For each subject in the curriculum, a corresponding `Quest` record is created in the database.
5.  A parent `QuestLine` record is created that links all the generated quests together.
6.  The generated quests are ordered based on the `term_number` in the `curriculum_structure`.
7.  The endpoint returns the ID of the newly created `QuestLine`.

## Tasks / Subtasks

- [ ] **Task 1: Create Generation Endpoint** (AC: #1, #2)
    - [ ] In `QuestsService`, create a new `QuestLinesController`.
    - [ ] Implement the `POST /api/quest-lines/generate-from-curriculum` endpoint.
- [ ] **Task 2: Implement Inter-Service Communication** (AC: #3)
    - [ ] Implement a client or repository within `QuestsService` to fetch curriculum data from the `UserService`'s new admin endpoints (from Story 2.1).
- [ ] **Task 3: Implement Generation Logic** (AC: #4, #5, #6)
    - [ ] Create a `QuestGenerationService` to contain the business logic.
    - [ ] The service should iterate through the subjects from the `curriculum_structure`.
    - [ ] For each subject, create and save a new `Quest` entity.
    - [ ] Create and save a parent `QuestLine` entity.
- [ ] **Task 4: Return Response** (AC: #7)
    - [ ] Ensure the controller returns a `201 Created` status with the new `QuestLine` ID.
- [ ] **Task 5: Write Integration Tests**
    - [ ] Write tests to verify that a valid curriculum version ID results in the correct creation of a QuestLine and its associated Quests.
    - [ ] Test the ordering of the generated quests.

## Dev Notes

### **Driving Requirement**
This implements the core logic of **FR9 (AI-Powered Curriculum Quest Generation)**, starting with a non-AI, rule-based version. The data created in **Story 2.1** will be the input for this process.

*Source: `docs/prd/requirements.md`*

### **Architectural Guidance**
*   **Repository**: This work is in the `QuestsService` project within the **`roguelearn-api`** monorepo.
*   **Inter-Service Communication**: This story requires the `QuestsService` to communicate with the `UserService`. Given they are in the same monorepo and will be deployed in the same environment, a direct HTTP call using a typed `HttpClient` is the recommended approach.
*   **Data Models**: This story will create `QuestLine` and `Quest` entities. The models should be based on the schema in `docs/service-databases/quests-service-database.md`.

*Source: `docs/fullstack-architecture/backend-architecture.md`*

### **Dependency**
This story is dependent on the completion of the `GET` endpoints in **Story 2.1**, as it needs to fetch the curriculum data to process.

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| [Current Date] | 1.0 | Initial story draft. | BMad Orchestrator |

## Dev Agent Record

### Agent Model Used
_TBD by Dev Agent_

### Debug Log References
_TBD by Dev Agent_

### Completion Notes List
_TBD by Dev Agent_

### File List
_TBD by Dev Agent_

## QA Results
_TBD by QA Agent_