# Story 3.2: Implement Guild Event Registration & Basic Leaderboard API

## Status

In Progress

## Ownership

*   **Primary Owner (Event Service):** Phuc
*   **Primary Owner (Social Service):** Minh Anh / An

## Target Deadline

Thursday, 23/10/2025

## Story

**As a** Guild Master,
**I want** to be able to register my guild for an approved event via an API in the **Event Service**, and **as a developer**, I need a way to fetch basic leaderboard results from that same service.

## Acceptance Criteria

1. An endpoint `POST /api/events/{eventId}/register-guild` is created in the **Event Service**. It accepts a `guildId` in the request body.
2. The registration endpoint performs a **secure, internal service-to-service call** to the `SocialService` to validate that the authenticated user is the `GuildMaster` of the provided `guildId`.
3. A `GET /api/events/{eventId}/leaderboard` endpoint is created in the **Event Service** that returns a simple, non-real-time list of top scores for a completed event.
4. The registration endpoint is protected, requiring a standard authenticated user JWT. The authorization logic is handled within the service by checking the user's role in the specified guild.
5. The leaderboard endpoint is public or requires standard authentication.

## Tasks / Subtasks

- [ ] **Task 1 (Event Service - Phuc): Create Guild Registration Endpoint** (AC: #1, #4)
    - [ ] Implement the `POST /api/events/{eventId}/register-guild` endpoint in a new `EventsController` within the Event Service.
    - [ ] The handler logic must extract the `auth_user_id` from the JWT.
- [ ] **Task 2 (Event Service - Phuc): Implement Service-to-Service Client for Social Service** (AC: #2)
    - [ ] Create a typed `HttpClient` or service client in the `EventService` to communicate with the `SocialService`.
    - [ ] Implement the logic to call the `SocialService`'s internal validation endpoint to verify the user's Guild Master status for the given guild.
- [ ] **Task 3 (Social Service - Minh Anh / An): Create Guild Master Validation Endpoint** (AC: #2)
    - [ ] In the `SocialService`, create a secure **internal** endpoint (e.g., `GET /internal/guilds/{guildId}/is-guild-master?userId={userId}`) that the `EventService` can call.
    - [ ] This endpoint should return a boolean indicating if the specified user is a master of that guild. This endpoint should not be exposed on the public API gateway.
- [ ] **Task 4 (Event Service - Phuc): Create Basic Leaderboard Endpoint** (AC: #3, #5)
    - [ ] In the `EventService`, implement the public-facing `GET /api/events/{eventId}/leaderboard` endpoint.
    - [ ] This endpoint should query the `submissions` or a `leaderboard_entries` table within its own database and return a ranked list of scores. **Real-time functionality is NOT required for this story.**
- [ ] **Task 5 (Team): Integration Testing**
    - [ ] Write an integration test in the `EventService` that mocks the `SocialService` response to test the registration logic.
    - [ ] Write an integration test in the `EventService` for the leaderboard endpoint.
    - [ ] Write an integration test in the `SocialService` for the internal guild master validation endpoint.
