# RougeLearn.BMAD.Documentation/docs/stories/1.2.authentication-service-integration.md
# Story 1.2: Authentication Service Integration

## Status

Done

## Story

**As a** Developer,
**I want** to integrate Supabase Authentication with proper error handling,
**so that** users can securely access the platform.

## Acceptance Criteria

1.  The Supabase Auth Helpers SDK (`@supabase/auth-helpers-nextjs`) is properly configured in the Next.js frontend.
2.  Backend API routes are protected by middleware that validates JWTs issued by Supabase.
3.  Authentication state (e.g., session, user) is managed effectively in the frontend using Supabase's provided hooks or context providers.
4.  Session persistence and token refresh are handled automatically by the Supabase SDK.
5.  Supabase's built-in rate limiting for authentication endpoints is enabled and configured.
6.  Proper error messages are displayed to the user for authentication failures (e.g., invalid credentials, email already in use).
7.  A PostgreSQL trigger is created in the Supabase database to synchronize new users from `auth.users` to the public `UserProfiles` table.

## Tasks / Subtasks

- [x] **Task 1: Backend Implementation (`roguelearn-api`)** (AC: #2, #7)
    - [x] Subtask 1.1: In the `roguelearn-api` solution, create a shared middleware project or utility to validate Supabase JWTs. Apply this middleware to protect API endpoints in all service projects (`UserService`, `QuestsService`, `SocialService`).
    - [x] Subtask 1.2: In the Supabase dashboard's SQL Editor, apply the database schema (including `user_profiles` table), then create the PostgreSQL function and trigger to automatically create a new `user_profiles` record when a new user signs up in `auth.users`.
- [x] **Task 2: Frontend Implementation (`roguelearn-web`)** (AC: #1, #3, #4, #6)
    - [x] Subtask 2.1: Install and configure the `@supabase/auth-helpers-nextjs` package.
    - [x] Subtask 2.2: Create the UI components for Login and Registration forms.
    - [x] Subtask 2.3: Implement the client-side logic for user sign-up, sign-in, and sign-out using the Supabase SDK.
    - [x] Subtask 2.4: Implement Next.js middleware (`middleware.ts`) to protect application routes, redirecting unauthenticated users to the login page.
    - [x] Subtask 2.5: Implement user-facing error handling for common authentication failures.
- [x] **Task 3: End-to-End Testing** (AC: #1-7)
    - [x] Subtask 3.1: Write integration tests to verify the full user registration flow, including the database trigger synchronization.
    - [x] Subtask 3.2: Write integration tests to verify that protected frontend routes and backend API endpoints are inaccessible without a valid session.

## Dev Notes

### **Authentication Flow Overview**
The authentication flow is managed by Supabase. The frontend client communicates directly with Supabase Auth via the SDK. Once a user is authenticated, the SDK securely stores the JWT. For every request to our backend API, the frontend API client will attach this JWT. Our backend middleware's only job is to validate this token. A database trigger handles creating our local user profile from the master `auth.users` table.

### **Backend: PostgreSQL Trigger for User Sync**
To synchronize new Supabase users to our `user_profiles` table, the following function and trigger must be created in the Supabase SQL Editor. **Crucially, this step must be performed *after* the initial database schema (including the `user_profiles` table) has been applied.**

*Source: `docs/fullstack-architecture/database-schema.md`, `docs/fullstack-architecture/high-level-architecture.md`*

```sql
-- Creates a trigger function that inserts a new row into public.user_profiles
create function public.handle_new_user()
returns trigger
language plpgsql
security definer set search_path = public
as $$
begin
  insert into public.user_profiles (auth_user_id, email, username, first_name, last_name)
  values (
    new.id,
    new.email,
    new.raw_user_meta_data->>'username', -- Assumes username is passed in metadata on signup
    new.raw_user_meta_data->>'first_name', -- Assumes first_name is passed
    new.raw_user_meta_data->>'last_name' -- Assumes last_name is passed
  );
  return new;
end;
$$;

-- Creates the trigger that calls the function after a new user is created
create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();
```

### **Backend: .NET JWT Validation Middleware**
In each .NET service (`UserService`, `QuestsService`, etc.), configure the middleware in `Program.cs` to validate JWTs issued by Supabase. This should be implemented in a shared way to be easily applied across all services in the monorepo.

*Source: `docs/fullstack-architecture/backend-architecture.md`*

```csharp
// In Program.cs
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options =>
    {
        options.Authority = builder.Configuration["Supabase:Url"];
        options.Audience = "authenticated"; // Default Supabase audience
        options.RequireHttpsMetadata = !builder.Environment.IsDevelopment();
        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuer = true,
            ValidIssuer = builder.Configuration["Supabase:Url"],
            ValidateAudience = true,
            ValidAudience = "authenticated",
            ValidateLifetime = true,
            ValidateIssuerSigningKey = true,
            IssuerSigningKey = new SymmetricSecurityKey(System.Text.Encoding.UTF8.GetBytes(builder.Configuration["Supabase:JwtSecret"]))
        };
    });

builder.Services.AddAuthorization();

// ... later in the file
app.UseAuthentication();
app.UseAuthorization();
```

### **Frontend: Next.js Route Protection Middleware**
Create a `middleware.ts` file in the root of the `roguelearn-web` project to protect routes.

*Source: `docs/fullstack-architecture/frontend-architecture.md`*

```typescript
// In middleware.ts
import { createServerClient } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function middleware(request: NextRequest) {
  let response = NextResponse.next({
    request: {
      headers: request.headers,
    },
  })

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return request.cookies.get(name)?.value
        },
        set(name: string, value: string, options) {
          request.cookies.set({
            name,
            value,
            ...options,
          })
          response = NextResponse.next({
            request: {
              headers: request.headers,
            },
          })
          response.cookies.set({
            name,
            value,
            ...options,
          })
        },
        remove(name: string, options) {
          request.cookies.set({
            name,
            value: '',
            ...options,
          })
          response = NextResponse.next({
            request: {
              headers: request.headers,
            },
          })
          response.cookies.set({
            name,
            value: '',
            ...options,
          })
        },
      },
    }
  )

  const {
    data: { user },
  } = await supabase.auth.getUser()

  // if user is not signed in and the current path is not /login or /signup, redirect the user to the login page
  if (!user && !request.nextUrl.pathname.startsWith('/login') && !request.nextUrl.pathname.startsWith('/signup')) {
    return NextResponse.redirect(new URL('/login', request.url))
  }

  return response
}

export const config = {
  matcher: [
    /*
     * Match all request paths except for the ones starting with:
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     * Feel free to modify this pattern to include more paths.
     */
    '/((?!_next/static|_next/image|favicon.ico).*)',
  ],
}
```

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| [Current Date] | 1.2 | Set status to Done upon completion. | Sarah, PO |
| [Current Date] | 1.1 | Clarified DB schema dependency and middleware scope. Set status to Approved. | Sarah, PO |
| [Previous Date] | 1.0 | Initial story draft | Bob, SM |

## Dev Agent Record

### Agent Model Used
_TBD by Dev Agent_

### Debug Log References
_TBD by Dev Agent_

### Completion Notes List
_TBD by Dev Agent_

### File List
_TBD by Dev Agent_

## QA Results
_TBD by QA Agent_
