# **Story 1.5: User Role Management**

## Status

Done

## Story

**As a** Game Master (Admin),
**I want** to create, assign, and manage user roles with appropriate permissions,
**so that** users can access functionality appropriate to their role in the system.

## Acceptance Criteria

1. A set of API endpoints are created to manage roles (create, read, update, delete).
2. An admin can assign roles to users and remove roles from users.
3. The system supports at least the following roles: Student (default), Guild Master, Verified Lecturer, and Game Master (Admin).
4. Role assignments are stored in the database and properly linked to user profiles.
5. The JWT validation middleware is enhanced to include role claims for authenticated users.
6. All role management endpoints must enforce role-based access control (RBAC), allowing only users with the 'Admin' role to access them.
7. The implementation must include xUnit integration tests to verify the functionality and security of each new endpoint.

## Tasks / Subtasks

- [x] **Task 1: Enhance Role-Based Authorization** (AC: #5, #6)
    - [x] In the `roguelearn-api` solution, enhance the shared authorization handler/policy to include role claims in the JWT.
    - [x] Ensure the JWT contains the user's roles when generated/refreshed.
    - [x] Update the JWT validation middleware to properly extract and validate role claims.
- [x] **Task 2: Create Endpoints for Role Management** (AC: #1, #3)
    - [x] In the `UserService`, create a new `RolesController`.
    - [x] Implement `GET /api/admin/roles` to list all roles.
    - [x] Implement `POST /api/admin/roles` to create a new role.
    - [x] Implement `PUT /api/admin/roles/{id}` to update a role.
    - [x] Implement `DELETE /api/admin/roles/{id}` to delete a role.
    - [x] Secure all endpoints with the 'Admin' role policy.
- [x] **Task 3: Create Endpoints for User Role Assignment** (AC: #2, #4)
    - [x] In the `UserService`, create endpoints for assigning roles to users.
    - [x] Implement `POST /api/admin/users/{userId}/roles` to assign a role to a user.
    - [x] Implement `DELETE /api/admin/users/{userId}/roles/{roleId}` to remove a role from a user.
    - [x] Implement `GET /api/admin/users/{userId}/roles` to get all roles for a user.
    - [x] Secure all endpoints with the 'Admin' role policy.
- [x] **Task 4: Implement Default Role Assignment** (AC: #3)
    - [x] Modify the user registration process to automatically assign the 'Student' role to new users.
    - [x] Update the PostgreSQL trigger that creates user profiles to also create the default role assignment.
- [x] **Task 5: Write Integration Tests** (AC: #7)
    - [x] Create a new test suite for all the role management endpoints.
    - [x] Write tests to verify that an admin user can successfully perform all CRUD operations on roles.
    - [x] Write tests to verify that an admin user can assign and remove roles from users.
    - [x] Write tests to verify that a non-admin user receives a `403 Forbidden` error when attempting to access any of these endpoints.

## Dev Notes

### **Driving Requirement**
This story implements the foundational role-based access control (RBAC) capabilities outlined in **NFR15 (Access Control)**. The focus is on creating the backend infrastructure and API endpoints for role management.

*Source: `docs/prd/requirements.md`*

### **Architectural Guidance**
* **Repository**: All work for this story will be done within the **`roguelearn-api`** .NET solution. This is a backend-only story.
* **Service**: The logical location for these role management endpoints is the **`UserService`**, as it owns the core user profile and their associated roles.
* **Database Tables**: This story will involve creating C# Entity Framework models and performing CRUD operations on the following tables: `roles` and `user_roles`.

*Source: `docs/fullstack-architecture/service-databases/user-service-database.md`*

### **API Specification**
* The endpoints created should follow the patterns defined in the OpenAPI specification for the admin-level endpoints.
* **Security**: This story builds on the JWT validation middleware from Story 1.2. The middleware should be extended to include role claims in the JWT and validate them for protected endpoints. All endpoints in the new controllers must be decorated with appropriate role-based authorization attributes.

*Source: `docs/fullstack-architecture/api-specification.md`*

### **Role Definitions**
The system should support the following roles as defined in the PRD:
* **Student**: Default role for all users, with basic access to learning features.
* **Guild Master**: Users who can create and manage guilds, with additional privileges.
* **Verified Lecturer**: Users with verified academic credentials, with enhanced educational capabilities.
* **Game Master (Admin)**: Privileged users with full administrative access to the platform.

*Source: `docs/prd/user-roles.md`*

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| [Current Date] | 1.0 | Initial story draft, focusing on role management capabilities. | Bob, SM |

## Dev Agent Record

### Agent Model Used
_TBD by Dev Agent_

### Debug Log References
_TBD by Dev Agent_

### Completion Notes List
_TBD by Dev Agent_

### File List
_TBD by Dev Agent_

## QA Results
_TBD by QA Agent_