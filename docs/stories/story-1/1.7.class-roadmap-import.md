# **Story 1.7: Class Roadmap Import (roadmap.sh)**

## Status

Done

## Story

**As a** Data Integrations Engineer,
**I want** to import a roadmap.sh PDF, parse it with an AI extraction pipeline (Semantic Kernel using Gemini) to produce normalized JSON, and then deserialize and persist the JSON into the database-backed User Service’s Classes and academic structures,
**so that** Classes are enriched with standardized skill paths and topics aligned with industry roadmaps.

## Acceptance Criteria

1. Import Source & Mapping
   - Read roadmap content from `extracted-data/roadmap/aspnet-core.pdf` (initial target) and use an AI extraction pipeline (Semantic Kernel with Gemini) to produce structured JSON.
   - Persist the extracted JSON snapshot to `extracted-data/roadmap-extracted/aspnet-core.json` for auditing and repeatability.
   - Map roadmap modules and topics to `classes` and `class_nodes` in the User Service DB; represent prerequisites via parent-child hierarchy (`parent_id`) and `sequence` ordering; optionally link curriculum placeholders via `class_specialization_subjects` when available; normalize difficulty levels (Beginner/Intermediate/Advanced).
2. Idempotent Import Process
   - Import operation upserts records; re-running the import using the same PDF/JSON snapshot does not duplicate data; deterministic keys derived from normalized titles and hierarchical paths (Class > Module > Topic) ensure idempotency across repeated AI parses.
   - Generate an import report summarizing created/updated/skipped records and any validation warnings.
3. Trigger Mechanism
   - Admin-only endpoint: `POST /api/admin/classes/import-roadmap` with parameters `{source: "aspnet-core", mode: "pdf_ai"}`. By default, the service reads `extracted-data/roadmap/aspnet-core.pdf`. Also supports `multipart/form-data` file upload via field `file`.
   - Optional CLI/Job trigger supports scheduled imports (download latest roadmap.sh PDF and run AI extraction before import).
4. Validation & Error Handling
   - Validate PDF availability, handle AI extraction errors (timeouts, empty or malformed output), and validate resulting JSON against schema and mapping consistency.
   - Return friendly errors and detailed report for failures, including AI pipeline logs (model, prompt version, tokens) when available.
5. Documentation
   - OpenAPI docs for import endpoint including report schema.
6. Testing
   - Integration tests using TestContainers (PostgreSQL) that run the import using a stubbed Semantic Kernel/Gemini provider returning the fixture `extracted-data/roadmap-extracted/aspnet-core.json`; assert correct mappings and idempotency.

## Tasks / Subtasks

- [x] Task 1: Data Model Review & Alignment
  - [x] Confirm existing tables per current User Service DB: `classes`, `class_nodes`, `class_specialization_subjects` (docs/fullstack-architecture/service-databases/user-service-database.md).
  - [x] No schema migrations for this story; represent prerequisites via `class_nodes.parent_id` hierarchy and `sequence` ordering; enforce idempotency in application logic using deterministic keys (derived from normalized titles and hierarchical paths).
- [x] Task 2: AI Extraction & Mapper
  - [x] Integrate Semantic Kernel with Gemini to extract structured JSON from `extracted-data/roadmap/aspnet-core.pdf` (prompt design, parsing strategy, and schema alignment).                                                                                                                           
  - [x] Implement a mapper that translates extracted nodes into class entities and relationships.
  - [x] Define difficulty normalization (e.g., Beginner/Intermediate/Advanced) based on source metadata and AI output.
- [x] Task 3: Import Service
  - [x] Create `ClassRoadmapImportService` that orchestrates AI extraction, mapping to `classes`/`class_nodes`/`class_specialization_subjects`, upsert, and reporting.
  - [x] Ensure idempotency via deterministic hierarchical path keys (Class > Module > Topic) and conflict handling.
- [x] Task 4: API & Job Trigger
  - [x] Create `AdminClassesController` endpoint: `POST /api/admin/classes/import-roadmap` that reads the PDF from `extracted-data/roadmap/aspnet-core.pdf` by default and supports `multipart/form-data` file upload.
  - [x] Optional background job or CLI command to download the latest roadmap.sh PDF and run AI extraction prior to import.
- [x] Task 5: Reporting & Error Handling
  - [x] Define `ImportReport` DTO with counts and warnings; include AI pipeline metadata (model, prompt version), and return on completion.
  - [x] Add detailed logging for created/updated/skipped items; persist the extracted JSON snapshot for auditability.
- [x] Task 6: OpenAPI & CI
  - [x] Document endpoint and report schema; verify in CI.
- [x] Task 7: Testing
  - [x] Integration tests that execute import using a stubbed Semantic Kernel/Gemini provider returning `extracted-data/roadmap-extracted/aspnet-core.json`.
  - [x] Idempotency test: run import twice (same PDF and same JSON fixture) and assert no duplicates.

## Dev Notes

### Driving Requirements
- Align class definitions with standardized roadmaps to improve curriculum coherence and skill path visibility.

*Source: `docs/fullstack-architecture/service-databases/user-service-database.md`*

### Architectural Guidance
- Implement within `roguelearn-api/UserService` as it owns academic structures and Classes.
- Use Admin RBAC and shared JWT validation middleware.
- Use the current User Service database schema (docs/fullstack-architecture/service-databases/user-service-database.md): persist Classes to `classes`, hierarchical content to `class_nodes`, and optional curriculum linkage to `class_specialization_subjects`. No new tables/migrations for this story.
- Prerequisites are represented via `class_nodes.parent_id` hierarchy and `sequence` ordering (no dedicated prerequisites table for Classes).
- Idempotent keys are computed from normalized hierarchical paths (Class > Module > Topic) for matching and upsert logic.

*Source: `docs/fullstack-architecture/backend-architecture.md`, `docs/fullstack-architecture/api-specification.md`, `docs/fullstack-architecture/service-databases/user-service-database.md`*

### Data Sources
- Primary: <mcfile name="aspnet-core.pdf" path="d:\Code Stuffs\MinhAnh2610\RogueLearn.BMAD.Documentation\extracted-data\roadmap\aspnet-core.pdf"></mcfile>
- Derived: <mcfile name="aspnet-core.json" path="d:\Code Stuffs\MinhAnh2610\RogueLearn.BMAD.Documentation\extracted-data\roadmap-extracted\aspnet-core.json"></mcfile> (generated via AI extraction)
- Reference: <mcfile name="aspnet-core.pdf" path="d:\Code Stuffs\MinhAnh2610\RogueLearn.BMAD.Documentation\extracted-data\roadmap\aspnet-core.pdf"></mcfile>

### Testing Strategy
- Use WebApplicationFactory and TestContainers for end-to-end import validation; stub the Semantic Kernel/Gemini provider to return deterministic JSON fixtures.

*Source: `docs/prd/technical-guidance.md`*

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| [Current Date] | 1.0 | Initial story draft | Bob, SM |
| [Current Date] | 1.1 | Revised to AI-based PDF → JSON import pipeline (Semantic Kernel + Gemini) | Bob, SM |

## Dev Agent Record

### Agent Model Used
_TBD by Dev Agent_

### Debug Log References
_TBD by Dev Agent_

### Completion Notes List
_TBD by Dev Agent_

### File List
_TBD by Dev Agent_

## QA Results
_TBD by QA Agent_