# **Story 1.10: Class Roadmap Management (post-import curation)**

## Status

Done

## Story

**As an** Academic Admin,
**I want** to curate and manage the roadmap class structure imported from roadmap.sh (modules, topics, sequence, and visibility),
**so that** the class content remains accurate, publishable, and aligned with our curriculum and skill catalog.

## Acceptance Criteria

1. Admin-only CRUD APIs for Classes
   - `GET /api/admin/classes` lists classes with filters: `isActive`, `difficultyLevel`, `search` (by name/description).
   - `GET /api/admin/classes/{classId}` returns class details.
   - `POST /api/admin/classes` creates a class with fields: `name`, `description`, `roadmap_url`, `skill_focus_areas` (string[]), `difficulty_level` (1..3), `estimated_duration_months` (optional), `is_active` (default true).
   - `PUT /api/admin/classes/{classId}` updates the above fields.
   - `DELETE /api/admin/classes/{classId}` sets `is_active = false` (soft deactivation); physical deletion is NOT performed.
2. Admin-only CRUD, Move, and Reorder for Class Nodes
   - `GET /api/admin/classes/{classId}/nodes?format=tree|flat` returns modules/topics in hierarchical order (default `format=tree`).
   - `POST /api/admin/classes/{classId}/nodes` creates a node with: `title` (required), `node_type` (e.g., `module`, `topic`, `checkpoint`), `description`, `parent_id` (optional for roots), `sequence` (optional; auto-normalized if omitted).
   - `PUT /api/admin/classes/{classId}/nodes/{nodeId}` updates editable fields: `title`, `node_type`, `description`, `sequence`.
   - `PATCH /api/admin/classes/{classId}/nodes/{nodeId}/move` moves a node under a new `parent_id` and sets a new `sequence`. Must validate: same `class_id`, no cycles.
   - `POST /api/admin/classes/{classId}/nodes/reorder` bulk reorders siblings by `{ parentId, items: [{ nodeId, sequence }] }`. Service normalizes sequences (e.g., 10-steps) and persists deterministic ordering.
   - `DELETE /api/admin/classes/{classId}/nodes/{nodeId}` deactivates a node (soft delete via `is_active = false`). If the node has children, they remain but are hidden from public queries unless explicitly re-parented.
3. Edit Locks to Protect AI Import Invariants
   - Nodes imported by Story 1.7 default to `is_locked_by_import = true`.
   - When locked: `title` and `node_type` are read-only via admin APIs; re-parent/move requires explicit unlock.
   - `PATCH /api/admin/classes/{classId}/nodes/{nodeId}/lock` body `{ isLocked: boolean, reason?: string }` toggles lock state; audit in logs.
4. Validation & Error Handling
   - Standard errors: 400 (validation), 403 (forbidden), 404 (not found), 409 (sequence conflict), 422 (move cycle detected), 500 (unexpected).
   - Validation examples: `title` non-empty; `sequence` integer >= 0; `parent_id` must be in same `class_id`; disallow cycles.
   - Bulk reorder is atomic; partial failures return 409 and do not persist.
5. Public Read APIs (Published View)
   - `GET /api/classes/{classId}` returns class details if `is_active = true`.
   - `GET /api/classes/{classId}/nodes?format=tree` returns only `is_active = true` nodes in order; locked state not exposed.
6. OpenAPI Documentation
   - Document admin and public endpoints, request/response schemas, auth requirements, and error models.
   - Include examples for `move` and `reorder` operations and cycle detection.
7. Testing
   - Integration tests using WebApplicationFactory + TestContainers (PostgreSQL) covering: CRUD, move, reorder, soft delete, locks, validations, and public filtering.
   - Idempotency tests confirm stable order after repeated reorders and consistent tree after move operations.

## Tasks / Subtasks

- [x] Task 1: Data Model Extension (User Service DB)
  - [x] Add columns to `class_nodes`:
    - `is_active BOOLEAN NOT NULL DEFAULT TRUE`
    - `is_locked_by_import BOOLEAN NOT NULL DEFAULT FALSE`
    - `metadata JSONB` (optional attributes such as `source`, `external_path_hash`, `difficulty`, etc.)
  - [x] Add index: `CREATE INDEX idx_class_nodes_class_parent_seq ON class_nodes(class_id, parent_id, sequence);`
  - [x] Confirm no changes to `classes` beyond existing fields; use `is_active` for soft deactivation.
- [x] Task 2: Repository & Services
  - [x] Implement hierarchical query (tree and flat) with `is_active` filtering.
  - [x] Implement create/update/delete (soft), move (with cycle detection), and bulk reorder operations.
  - [x] Implement sequence normalization and deterministic ordering.
  - [x] Implement lock enforcement on edit/move when `is_locked_by_import = true`.
- [x] Task 3: API Controllers
  - [x] `ClassesController`: class CRUD.
  - [x] `ClassNodesController`: nodes CRUD, move, reorder, lock toggle.
  - [x] `ClassesController` (public): class read and tree read with `is_active` filtering.
  - [x] Apply JWT validation middleware and Admin RBAC policies.
- [x] Task 4: Error Handling & Logging
  - [x] Centralize error responses; enforce atomicity on bulk reorder.
  - [x] Structured logs on create/update/delete/move/lock changes (actor, resource IDs, fields changed).
- [x] Task 5: OpenAPI & Documentation
  - [x] Define schemas: `Class`, `ClassNode`, `ClassNodeMoveRequest`, `ClassNodeReorderRequest`, `Error`.
  - [x] Add examples including cycle detection and lock enforcement.
  - [x] Publish OpenAPI and ensure CI validation.
- [x] Task 6: Testing
  - [x] Integration tests for happy paths (CRUD, move, reorder, soft delete, locks).
  - [x] Negative tests (invalid input, forbidden, 404, 409, 422, lock violations).
  - [x] Idempotency tests (stable ordering after reorders).
- [x] Task 7: Performance & Indexes
  - [x] Verify query plans for `class_id`, `parent_id`, `sequence` filters.
  - [x] Confirm new index usage and acceptable latency for typical dataset sizes.

## Dev Notes

### Ownership & Architecture
- Roadmap classes and nodes are owned by the User Service. Management operations MUST be implemented within `roguelearn-api/UserService`.
- Admin RBAC applies; public API is read-only and filtered by `is_active`.

### Alignment with AI Import (Story 1.7)
- Imported nodes should be marked `is_locked_by_import = true` to preserve AI-imported structure.
- Manual edits can be made after unlocking; consider storing original import path in `metadata.external_path_hash` for traceability.
- Maintain deterministic ordering (sequence) to keep idempotency of future import runs.

### Data Model
- Tables referenced: `classes`, `class_nodes`, optionally `class_specialization_subjects` for curriculum links.
- Proposed additions in this story (migrations): `is_active`, `is_locked_by_import`, `metadata` for `class_nodes` and an index on `(class_id, parent_id, sequence)`.
- See: `docs/fullstack-architecture/service-databases/user-service-database.md` for current schema.

### Security
- JWT validation (Story 1.2) and Admin RBAC policies required for all admin endpoints.
- Public endpoints must only return `is_active = true` classes and nodes.

### UI/UX Context
- Backend scope only. Future admin UI will call these endpoints to curate roadmaps.
- Tree operations should be efficient to support drag-and-drop UIs.

### Testing Strategy
- WebApplicationFactory + TestContainers for PostgreSQL.
- Include cycle detection tests and lock enforcement tests.

### Sources & References
- `docs/fullstack-architecture/service-databases/user-service-database.md`
- `docs/fullstack-architecture/database-per-service.md`
- `docs/prd/requirements.md`

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| [Current Date] | 1.0 | Initial story draft | Bob, SM |

## Dev Agent Record

### Agent Model Used
_TBD by Dev Agent_

### Debug Log References
_TBD by Dev Agent_

### Completion Notes List
_TBD by Dev Agent_

### File List
_TBD by Dev Agent_

## QA Results
_TBD by QA Agent_