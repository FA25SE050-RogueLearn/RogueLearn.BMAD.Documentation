# **Story 1.8: Notes Management (Arsenal)**

## Status

Draft

## Story

**As a** student/player,
**I want** to create, organize, and link personal study notes in my "Arsenal",
**so that** I can build a centralized knowledge base and contextually surface notes across skill tree nodes and quests.

## Acceptance Criteria

1. CRUD for personal notes (owned by User Service)
   - `GET /api/notes` returns the authenticated user's notes, with filters (see AC#2).
   - `POST /api/notes` creates a note with fields: `title`, `content` (JSONB), `is_public` (default false), optional `tags`.
   - `GET /api/notes/{id}` returns a note the authenticated user owns (or any public note if `is_public = true`).
   - `PUT /api/notes/{id}` updates `title`, `content`, `is_public`, and tags for the authenticated user's note.
   - `DELETE /api/notes/{id}` deletes the authenticated user's note.
   - All endpoints require JWT validation and enforce owner-only access except public read for `GET /api/notes/{id}` when `is_public = true`.
2. Filtering, search, and linking
   - Support filters on `GET /api/notes`: `questId`, `skillId`, `tag`, `search` (title/content text search), `isPublic`.
   - Linking endpoints:
     - `POST /api/notes/{id}/link-quests` body `{ questIds: UUID[] }` upserts `note_quests` mappings.
     - `POST /api/notes/{id}/link-skills` body `{ skillIds: UUID[] }` upserts `note_skills` mappings.
   - Tag management:
     - `POST /api/notes/{id}/tags` body `{ tags: string[] }` creates missing user tags and maps via `note_tags`.
     - `DELETE /api/notes/{id}/tags` body `{ tags: string[] }` removes specific mappings (keeps tag catalog intact).
3. Data model alignment (User Service DB)
   - Persist notes in `notes` table with JSONB `content` and `is_public` flag.
   - Maintain many-to-many linking via `note_quests` (soft quest reference) and `note_skills` (FK to User Service `skills`).
   - Maintain tag catalog per user in `tags` and mappings via `note_tags`.
   - Ensure indexes exist and are used for performance: `idx_notes_auth_user_id`, `idx_note_tags_note_id`, `idx_note_tags_tag_id`.
4. Cross-service integration (delegation and consumption)
   - Quests Service and frontend may call `GET /api/notes?questId=...` to list notes linked to a quest.
   - If Quests Service exposes `/notes` endpoints, it MUST delegate to User Service over internal service-to-service auth, not own note storage.
   - Social Service integrations (Party Stash) read-only snapshot sharing is out of scope for this story; ensure future extensibility with `original_note_id` soft references.
5. Error handling and security
   - Standardized error responses: 400 (validation), 403 (forbidden), 404 (not found), 409 (conflict on tag name uniqueness), 500 (unexpected).
   - RBAC: Owner-only CRUD; Admin may read any note (for moderation/audit) but cannot edit non-owned notes.
   - Input validation: `title` not empty; `content` must be valid JSON; `tags` max length 50; reasonable note size limits (e.g., 1MB content).
6. OpenAPI documentation
   - Document all endpoints, request/response schemas (`Note`, `Tag`, `NoteLinkRequest`), auth requirements, and error models.
   - Include filter parameters and example queries.
7. Testing
   - Integration tests using WebApplicationFactory + TestContainers (PostgreSQL) covering: CRUD, filters, linking, tag ops, public read, RBAC enforcement, and error cases.
   - Contract tests confirm `Note` and filter response shapes for cross-service clients.

## Tasks / Subtasks

- [ ] Task 1: Domain & Data Models
  - [ ] Define EF Core models: `Note` (id, auth_user_id, title, content JSONB, is_public, created_at, updated_at), `Tag`, join entities `NoteQuest`, `NoteSkill`, `NoteTag`.
  - [ ] Configure value conversion for JSONB content and validation logic.
  - [ ] Ensure migrations match existing schema (see Dev Notes) and include any missing indexes.
- [ ] Task 2: Repository & Services
  - [ ] Implement repository methods: list (with filters), get by id (owner or public), create, update, delete.
  - [ ] Implement linking services for quests/skills upsert logic and tag attach/detach.
  - [ ] Implement text search (basic ILIKE over title and content text extraction) with future-proofing for full-text.
- [ ] Task 3: API Controllers
  - [ ] `NotesController`: `GET /api/notes`, `POST /api/notes`, `GET/PUT/DELETE /api/notes/{id}`.
  - [ ] `NoteLinksController`: `POST /api/notes/{id}/link-quests`, `POST /api/notes/{id}/link-skills`.
  - [ ] `NoteTagsController`: `POST /api/notes/{id}/tags`, `DELETE /api/notes/{id}/tags`.
  - [ ] Apply JWT validation middleware (Story 1.2) and RBAC policies.
- [ ] Task 4: Error Handling & Logging
  - [ ] Centralized error handling with standardized error object.
  - [ ] Structured logs on create/update/delete (actor, noteId, fields changed) without content leakage.
- [ ] Task 5: OpenAPI & Documentation
  - [ ] Define schemas (`Note`, `Tag`, `NoteListResponse`, `Error`).
  - [ ] Document filters and linking semantics with examples.
  - [ ] Publish OpenAPI and ensure CI validation.
- [ ] Task 6: Testing
  - [ ] Integration tests for happy paths and RBAC.
  - [ ] Negative tests (invalid input, forbidden, not found, tag conflicts).
  - [ ] Contract tests for `Note` schema and filter outputs.
- [ ] Task 7: Performance & Indexes
  - [ ] Verify read/write performance with expected data volumes.
  - [ ] Ensure indexes are used by queries (owner filter, tag joins, quest/skill joins).

## Dev Notes

### Ownership & Architecture
- Personal notes (Arsenal) are owned by the User Service. Quests Service and other clients consume notes via User Service APIs and soft references.
- Delegation pattern: Any `/notes` endpoints exposed by other services or API Gateway must delegate to the User Service.

### Data Model (User Service)
- Tables: `notes`, `note_quests`, `note_skills`, `tags`, `note_tags` with JSONB `content` and `is_public` flag.
- Indexes: `idx_notes_auth_user_id`, `idx_note_tags_note_id`, `idx_note_tags_tag_id` (see references).

### Security
- JWT validation via shared middleware (Story 1.2).
- Owner-only CRUD; Admin can read for moderation/audit. Public read allowed for `is_public = true` notes.
- Privacy-first: default `is_public = false`.

### UI/UX Context
- The Frontend must provide a Notion-like editor for rich text content and tagging (see references). This story focuses on backend/API; frontend integration will be handled in a future story.

### Cross-Service Usage
- From quest views, clients filter notes via `GET /api/notes?questId=...`.
- Skill tree nodes can surface linked notes via `GET /api/notes?skillId=...`.

### Testing Strategy
- WebApplicationFactory + TestContainers for PostgreSQL to simulate end-to-end.
- Contract tests to ensure response shapes remain stable across services.

### Sources & References
- `docs/fullstack-architecture/service-databases/user-service-database.md` (Notes Management section)
- `docs/fullstack-architecture/database-per-service.md` (ownership and cross-service access)
- `docs/prd/requirements.md` (FR14, FR15, FR23, FR24)
- `docs/prd/user-interface-design-goals.md` (Arsenal/Notes Editor)
- `docs/fullstack-architecture/service-apis/quests-service-api.md` (ensure delegation if `/notes` is exposed there)

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| [Current Date] | 1.0 | Initial story draft | Bob, SM |

## Dev Agent Record

### Agent Model Used
_TBD by Dev Agent_

### Debug Log References
_TBD by Dev Agent_

### Completion Notes List
_TBD by Dev Agent_

### File List
_TBD by Dev Agent_

## QA Results
_TBD by QA Agent_