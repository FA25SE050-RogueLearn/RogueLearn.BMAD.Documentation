# **Story 1.6: Skills and Achievements Management**

## Status

Draft

## Story

**As a** Platform Engineer,
**I want** to implement Skills and Achievements management in the User Service,
**so that** users can progress through skill trees, earn XP, and unlock achievements consistently across the platform.

## Acceptance Criteria

1. Skills Catalog & Dependencies
   - `GET /api/skills` and `GET /api/skills/{id}` for public catalog access.
   - Admin-only endpoints: `POST /api/admin/skills`, `PUT /api/admin/skills/{id}`, `DELETE /api/admin/skills/{id}`.
   - Skill graph endpoints: `GET /api/skills/{id}/dependencies`, Admin-only `POST /api/admin/skills/{id}/dependencies` and `DELETE /api/admin/skills/{id}/dependencies/{prereqId}`.
2. XP Ledger & Skill Progression
   - `POST /api/users/{id}/xp-events` ingests XP events (source: quest completion, code battle results, study activity) and updates `user_skills` progression.
   - Idempotency: XP events include a unique eventId to prevent double application.
   - Concurrency: Operations are transactional and safe under concurrent requests.
3. Achievements Awarding
   - `GET /api/achievements` public catalog.
   - `GET /api/users/{id}/achievements` lists userâ€™s unlocked achievements.
   - System triggers evaluate achievement rules during XP application; awards are idempotent.
4. Rewards & Skill Rewards
   - `GET /api/users/{id}/skill-rewards` lists earned skill rewards; consistent with XP thresholds and rules.
5. Security & RBAC
   - All endpoints enforce JWT validation and role enforcement (Admin for catalog mutation; self-access for personal progression views).
6. Documentation & Contracts
   - OpenAPI documented for request/response schemas and error models.
   - Event contract for XP ingestion documented and versioned.
7. Testing
   - xUnit integration tests with WebApplicationFactory + TestContainers (PostgreSQL) covering catalog CRUD, XP ingestion, achievement awarding, and RBAC.

## Tasks / Subtasks

- [ ] Task 1: Domain Models & Migrations
  - [ ] Ensure EF models exist for `skills`, `skill_dependencies`, `user_skills`, `achievements`, `user_achievements`, `user_skill_rewards`, and XP event ledger.
  - [ ] Add/verify migrations for indexes supporting catalog queries and progression updates.
- [ ] Task 2: Services & Rules Engine
  - [ ] Implement `SkillsService` for catalog and dependency management.
  - [ ] Implement `XpLedgerService` to ingest events, apply XP to `user_skills`, and emit domain events.
  - [ ] Implement `AchievementService` that evaluates rules on domain events and awards achievements idempotently.
- [ ] Task 3: API Controllers
  - [ ] `SkillsController` (public) and `AdminSkillsController` (Admin-only) for CRUD.
  - [ ] `SkillDependenciesController` for graph operations.
  - [ ] `XpEventsController` for XP ingestion.
  - [ ] `AchievementsController` and `UserAchievementsController` for listing achievements.
  - [ ] `UserSkillRewardsController` for listing skill rewards.
- [ ] Task 4: Event Contracts & Cross-Service Integration
  - [ ] Define event schema for XP events (questId, sourceService, points, eventId, timestamp).
  - [ ] Add minimal ingestion endpoint that can be called by Quests/Social/Meeting/CodeBattle services.
- [ ] Task 5: Error Handling & Logging
  - [ ] Standardize error responses (400/403/404) and add structured logs for XP applications and awards.
- [ ] Task 6: OpenAPI & CI
  - [ ] Document all endpoints and models; ensure CI validates OpenAPI.
- [ ] Task 7: Testing
  - [ ] Integration tests for skills CRUD and dependencies graph.
  - [ ] XP ingestion tests including idempotency and concurrency-safe behavior.
  - [ ] Achievement awarding tests verifying rules and idempotent awards.

## Dev Notes

### Driving Requirements
- Skills progression and achievement unlocking are core gamification features owned by the User Service.

*Source: `docs/fullstack-architecture/service-databases/user-service-database.md`*

### Architectural Guidance
- Implement services within `roguelearn-api/UserService`.
- Use shared JWT validation middleware from Story 1.2.
- Ensure progression logic is deterministic and idempotent for reliability.

*Source: `docs/fullstack-architecture/backend-architecture.md`, `docs/fullstack-architecture/api-specification.md`*

### Testing Strategy
- Use WebApplicationFactory and TestContainers for true integration coverage.
- Include tests for domain rules and event idempotency.

*Source: `docs/prd/technical-guidance.md`*

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| [Current Date] | 1.0 | Initial story draft | Bob, SM |

## Dev Agent Record

### Agent Model Used
_TBD by Dev Agent_

### Debug Log References
_TBD by Dev Agent_

### Completion Notes List
_TBD by Dev Agent_

### File List
_TBD by Dev Agent_

## QA Results
_TBD by QA Agent_