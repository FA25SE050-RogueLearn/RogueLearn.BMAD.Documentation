# **Story 1.6: Skills and Achievements Management**

## Status

Done

## Story

**As a** Platform Engineer,
**I want** to implement Skills and Achievements management in the User Service following our CQRS pattern (thin controllers, all logic in handlers),
**so that** users can progress through skill trees, earn XP, manage their own skills, and unlock achievements consistently across the platform.

## Acceptance Criteria

1. CQRS Controllers & Endpoint Structure
   - Controllers are thin; all business logic is implemented in CommandHandlers and QueryHandlers.
   - Skills endpoints (same controller; mutation endpoints marked with `[AdminOnly]`, no separate Admin controller):
     - Queries:
       - `GET /api/admin/skills`
       - `GET /api/admin/skills/{id}`
       - `GET /api/admin/skills/{id}/dependencies`
     - Commands (AdminOnly on actions below, same controller):
       - `POST /api/admin/skills`
       - `PUT /api/admin/skills/{id}`
       - `DELETE /api/admin/skills/{id}`
       - `POST /api/admin/skills/{id}/dependencies`
       - `DELETE /api/admin/skills/{id}/dependencies/{prereqId}`
   - Achievements:
     - `GET /api/achievements` (public catalog, QueryHandler)
   - User achievements (controller hosts queries and the XP ingestion command):
     - `GET /api/users/{id}/achievements` (QueryHandler)
     - `POST /api/users/{id}/xp-events` (CommandHandler; endpoint moved here, no separate XpEventsController)
   - Rewards:
     - `GET /api/users/{id}/skill-rewards` (QueryHandler)

2. User Skills Management
   - Provide endpoints to list, view, track/untrack, update preferences, and reset a user's skills, all via CQRS handlers.
   - UserSkillsController (self-access for the authenticated user; AdminOnly for resets/overrides):
     - Queries:
       - `GET /api/users/{id}/skills` (List all of the user's skills with fields like `level`, `totalXp`, `progressPercent`, `isTracked`, `pinned`, `targetLevel`)
       - `GET /api/users/{id}/skills/{skillId}` (Detail for a specific skill)
     - Commands:
       - `POST /api/users/{id}/skills` (Track/assign a skill to the user; idempotent upsert on `(userId, skillId)`; enforces graph prerequisites)
       - `DELETE /api/users/{id}/skills/{skillId}` (Untrack/remove from active tracking; preserves historical progression; idempotent)
       - `PATCH /api/users/{id}/skills/{skillId}/preferences` (Update `pinned` and `targetLevel`; self-access only)
       - `[AdminOnly] POST /api/users/{id}/skills/{skillId}/reset` (Reset progression to defaults; audit reason required)
   - Validation & Rules:
     - Tracking a skill checks prerequisite dependencies; if not met, returns `409 Conflict` with details of missing prerequisites.
     - Manual level/XP changes are not exposed to users; all progression changes happen via XP ingestion domain events. Admin-only resets do not directly set arbitrary XP.
     - Idempotent behavior for track/untrack and preference updates.
     - Concurrency-safe operations with transactions on user skill rows.

3. XP Ledger & Skill Progression (Command side)
   - `POST /api/users/{id}/xp-events` dispatches `IngestXpEventCommand` to apply XP to `user_skills` and emit domain events.
   - Idempotency: XP events include a unique `eventId` to prevent double application.
   - Concurrency: Operations are transactional and safe under concurrent requests.

4. Achievements Awarding
   - `GET /api/achievements` public catalog.
   - `GET /api/users/{id}/achievements` lists the userâ€™s unlocked achievements.
   - Achievement rules are evaluated in handlers on domain events during XP application; awards are idempotent.

5. Rewards & Skill Rewards
   - `GET /api/users/{id}/skill-rewards` lists earned skill rewards; consistent with XP thresholds and rules.

6. Security & RBAC
   - All endpoints enforce JWT validation and role enforcement.
   - Admin-only skill/graph mutation endpoints use `[AdminOnly]` attribute on actions in the same controller (no separate Admin controller).
   - Self-access for personal progression views and user skill tracking/preferences endpoints.

7. Documentation & Contracts
   - OpenAPI documents request/response schemas and error models.
   - Document CQRS separation (Query vs Command tags) and that controllers are thin with logic in handlers.
   - Event contract for XP ingestion documented and versioned.

8. Testing
   - xUnit integration tests with WebApplicationFactory + TestContainers (PostgreSQL/Supabase) covering catalog CRUD, user skill management, XP ingestion, achievement awarding, and RBAC.
   - Handler-focused unit tests for command/query behaviors, domain events, and idempotency.

9. Predefined Achievements Seed (Supabase)
   - Seed an initial achievements catalog into Supabase (Postgres) on startup or via migration/seed script.
   - Minimum set includes (keys are unique):
     - `first_quest_completed`: Complete your first quest
     - `xp_100`: Reach 100 total XP
     - `xp_500`: Reach 500 total XP
     - `xp_1000`: Reach 1000 total XP
     - `quests_5_completed`: Complete 5 quests
     - `quests_20_completed`: Complete 20 quests
     - `code_battle_win_1`: Win your first code battle
     - `code_battle_win_10`: Win 10 code battles
     - `study_streak_7`: Study 7 consecutive days
     - `skill_level_1_any`: Reach level 1 in any skill
     - `skill_level_5_any`: Reach level 5 in any skill
     - `skill_level_10_any`: Reach level 10 in any skill
   - Each achievement defines: `key`, `name`, `description`, `ruleType` (threshold|streak|composite), `ruleConfig` (JSON, e.g. `{ "totalXp": 100 }`), `category`, `icon`, `version`, `isActive`.
   - Provide a Supabase-compatible SQL seed that upserts by unique `key` (example in Dev Notes).

## Tasks / Subtasks

- [x] Task 1: Domain Models & Migrations
  - [x] Ensure EF models exist for `skills`, `skill_dependencies`, `user_skills`, `achievements`, `user_achievements`, `user_skill_rewards`, and XP event ledger.
  - [x] Add/verify migrations for indexes supporting catalog queries and progression updates.
  - [x] Ensure `achievements.key` has a unique index for safe upserts in Supabase.
  - [x] Update `user_skills` schema with fields: `user_id`, `skill_id`, `level`, `total_xp`, `progress_percent`, `is_tracked`, `pinned`, `target_level`, `unlocked_at`, `last_updated_at`.
  - [x] Add unique index `(user_id, skill_id)` and supporting indexes on `is_tracked`, `pinned`, `target_level`.
- [x] Task 2: CQRS Handlers & Domain Events
  - [x] Implement QueryHandlers: `GetSkillsQuery`, `GetSkillByIdQuery`, `GetSkillDependenciesQuery`, `GetAchievementsQuery`, `GetUserAchievementsQuery`, `GetUserSkillRewardsQuery`, `GetUserSkillsQuery`, `GetUserSkillQuery`.
  - [x] Implement CommandHandlers: `CreateSkillCommand`, `UpdateSkillCommand`, `DeleteSkillCommand`, `AddSkillDependencyCommand`, `RemoveSkillDependencyCommand`, `IngestXpEventCommand`, `AddUserSkillCommand`, `RemoveUserSkillCommand`, `UpdateUserSkillPreferencesCommand`, `[AdminOnly] ResetUserSkillProgressCommand`.
  - [x] Implement domain event handlers: `XpAppliedDomainEventHandler` (updates progression, emits events), `AchievementEvaluationHandler` (evaluates and awards idempotently).
  - [x] Controllers remain thin: map HTTP to queries/commands only; no business logic in controllers.
- [x] Task 3: API Controllers
  - [x] `SkillsController` hosts both queries and admin mutations; add `[AdminOnly]` to mutation actions.
  - [x] `SkillDependenciesController` for graph operations; mutation actions marked `[AdminOnly]`.
  - [x] `UserSkillsController` for user skill management (queries, track/untrack, preferences, reset).
  - [x] Remove `XpEventsController`; move `POST /api/users/{id}/xp-events` to `UserAchievementsController`.
  - [x] `AchievementsController` for catalog queries; `UserAchievementsController` for user queries and XP ingestion command.
  - [x] `UserSkillRewardsController` for listing skill rewards.
- [x] Task 4: Event Contracts & Cross-Service Integration
  - [x] Define event schema for XP events (questId, sourceService, points, eventId, timestamp).
  - [x] Ensure the ingestion endpoint can be called by Quests/Social/Meeting/CodeBattle services.
- [x] Task 5: Error Handling & Logging
  - [x] Standardize error responses (400/403/404/409) and add structured logs for XP applications and awards.
  - [x] Include correlation via `eventId` in logs; clearly tag Query vs Command handler logs.
  - [x] Add audit logging for `[AdminOnly]` resets (who, when, why, before/after snapshot).
- [x] Task 6: OpenAPI & CI
  - [x] Document all endpoints and models; ensure CI validates OpenAPI and CQRS tags.
- [x] Task 7: Testing
  - [x] Integration tests for skills CRUD and dependencies graph.
  - [x] User skill management tests: track/untrack, preference updates, prerequisite enforcement (409), and self-access vs admin-only reset.
  - [x] XP ingestion tests including idempotency and concurrency-safe behavior.
  - [x] Achievement awarding tests verifying rules and idempotent awards.
  - [x] RBAC tests validating `[AdminOnly]` and self-access.
- [x] Task 8: Database Seeding (Supabase)
  - [x] Create a Supabase SQL/EF migration seeder for predefined achievements (upsert on `key`).
  - [x] Verify seeds load correctly in environments and are idempotent.

## Dev Notes

### Driving Requirements
- Skills progression and achievement unlocking are core gamification features owned by the User Service.

*Source: `docs/fullstack-architecture/service-databases/user-service-database.md`*

### Architectural Guidance
- Adopt CQRS with thin controllers that dispatch to handlers; all business logic resides in handlers.
- Implement within `roguelearn-api/UserService`.
- Use shared JWT validation middleware from Story 1.2.
- Ensure progression logic is deterministic and idempotent for reliability.
- Use Supabase (Postgres) as the database; prefer upsert-based seeds.

*Source: `docs/fullstack-architecture/backend-architecture.md`, `docs/fullstack-architecture/api-specification.md`*

### Supabase Achievement Seed (example SQL)
- Use a unique `key` on `achievements` and upsert. Adjust column names to match the actual schema.

```sql
-- Example upsert seeds (PostgreSQL/Supabase)
INSERT INTO achievements (key, name, description, rule_type, rule_config, category, icon, version, is_active)
VALUES
  ('first_quest_completed','First Quest Completed','Complete your first quest','threshold','{"questsCompleted":1}','core','trophy',1,true),
  ('xp_100','100 XP Earned','Reach a total of 100 XP','threshold','{"totalXp":100}','progression','star',1,true),
  ('xp_500','500 XP Earned','Reach a total of 500 XP','threshold','{"totalXp":500}','progression','star',1,true),
  ('xp_1000','1000 XP Earned','Reach a total of 1000 XP','threshold','{"totalXp":1000}','progression','star',1,true),
  ('quests_5_completed','Quest Apprentice','Complete 5 quests','threshold','{"questsCompleted":5}','quests','trophy',1,true),
  ('quests_20_completed','Quest Journeyman','Complete 20 quests','threshold','{"questsCompleted":20}','quests','trophy',1,true),
  ('code_battle_win_1','Code Battle Winner','Win your first code battle','threshold','{"codeBattlesWon":1}','codebattle','medal',1,true),
  ('code_battle_win_10','Code Battle Champion','Win 10 code battles','threshold','{"codeBattlesWon":10}','codebattle','medal',1,true),
  ('study_streak_7','Study Streak 7','Study 7 consecutive days','streak','{"days":7}','study','flame',1,true),
  ('skill_level_1_any','Skill Novice','Reach level 1 in any skill','threshold','{"skillLevelAny":1}','skills','badge',1,true),
  ('skill_level_5_any','Skill Apprentice','Reach level 5 in any skill','threshold','{"skillLevelAny":5}','skills','badge',1,true),
  ('skill_level_10_any','Skill Master','Reach level 10 in any skill','threshold','{"skillLevelAny":10}','skills','badge',1,true)
ON CONFLICT (key) DO UPDATE SET
  name = EXCLUDED.name,
  description = EXCLUDED.description,
  rule_type = EXCLUDED.rule_type,
  rule_config = EXCLUDED.rule_config,
  category = EXCLUDED.category,
  icon = EXCLUDED.icon,
  version = EXCLUDED.version,
  is_active = EXCLUDED.is_active;
```

### Testing Strategy
- Use WebApplicationFactory and TestContainers for true integration coverage.
- Include tests for domain rules, CQRS handlers, user skill management, and event idempotency.

*Source: `docs/prd/technical-guidance.md`*

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| [Current Date] | 1.2 | Added User Skills Management endpoints, handlers, models; maintained CQRS; AdminOnly usage in same controller; moved XP ingestion endpoint to UserAchievementsController; and added Supabase seed plan | Dev Agent |
| [Previous Date] | 1.1 | Revised for CQRS handlers, AdminOnly usage in same controller, moved XP ingestion endpoint to UserAchievementsController, and added Supabase seed plan | Dev Agent |
| [Original Date] | 1.0 | Initial story draft | Bob, SM |

## Dev Agent Record

### Agent Model Used
_TBD by Dev Agent_

### Debug Log References
_TBD by Dev Agent_

### Completion Notes List
_TBD by Dev Agent_

### File List
_TBD by Dev Agent_

## QA Results
_TBD by QA Agent_