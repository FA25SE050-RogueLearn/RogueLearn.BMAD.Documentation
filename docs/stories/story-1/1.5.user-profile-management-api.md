# **Story 1.5: User Profile Management API**

## Status

Done

## Story

**As a** Developer,
**I want** to implement core User Service APIs for user profile management and cross-service user context,
**so that** users can view/update their profile and other services can reliably consume normalized user context.

## Acceptance Criteria

1. Implement secured endpoints for profile retrieval and update:
   - `GET /api/users/me` returns the authenticated user's profile with roles and basic statistics.
   - `PATCH /api/users/me` allows updating allowed profile fields (first_name, last_name, username, avatar_url, bio, preferences) and rejects changes to immutable fields (email, auth_user_id).
   - `GET /api/admin/users/{id}` returns another user's profile and is restricted to Admin role.
2. Implement user context endpoint:
   - `GET /api/users/{id}/context` returns a normalized user context object (id, username, display_name, roles, class, curriculum_version, enrollment status, skill summary, achievements count) for cross-service consumption.
3. Enforce RBAC and JWT validation:
   - All endpoints use the shared JWT validation middleware from Story 1.2 and enforce role-based authorization (self-access vs admin-only operations).
4. Avatar storage integration:
   - Integrate with Supabase Storage (bucket: `avatars`) for saving and retrieving user avatar URLs; support client-provided pre-signed uploads and server-side validation of URL format.
5. Error handling and validation:
   - Implement consistent error responses aligned with PRD Error Handling guidelines (e.g., 400 for invalid input, 403 for forbidden, 404 for not found) with user-friendly messages.
6. OpenAPI documentation:
   - All endpoints documented with request/response schemas, auth requirements, and error models.
7. Testing:
   - xUnit integration tests with WebApplicationFactory + TestContainers (PostgreSQL) covering success/failure and RBAC paths.
   - Contract tests verify the shape of `UserContext` for cross-service clients.

## Tasks / Subtasks

- [x] Task 1: Domain & Data Models
  - [x] Define EF Core models and DTOs for `UserProfile`, `UserContext`, and `UserPreferences` (if not already present).
  - [x] Add AutoMapper profiles for mapping entities to DTOs.
  - [x] Ensure database migrations cover required fields (avatar_url, bio, preferences JSON) without altering immutable fields.
- [x] Task 2: Service Layer & Repository
  - [x] Implement repository methods for fetching/updating the authenticated user's profile and fetching another user's profile by id.
  - [x] Implement `UserContextService` that composes data from user profiles, roles, class, curriculum/enrollment, skills, achievements (read-only joins as needed).
- [x] Task 3: API Controllers
  - [x] Create `UsersController` with endpoints: `GET /api/users/me`, `PATCH /api/users/me`.
  - [x] Create `AdminUsersController` with endpoint: `GET /api/admin/users/{id}` (Admin-only).
  - [x] Add `UserContextController` with endpoint: `GET /api/users/{id}/context`.
  - [x] Apply JWT validation and RBAC attributes/policies to controllers and actions.
- [x] Task 4: Avatar Storage Integration
  - [x] Configure Supabase Storage client abstraction in User Service.
  - [x] Validate avatar URLs (bucket domain, path format) and update `avatar_url` field on successful save.
  - [x] Document client flow for pre-signed upload and server-side acceptance.
- [x] Task 5: Error Handling & Logging
  - [x] Implement centralized error handling middleware/filters returning standardized error objects.
  - [x] Add structured logs for profile updates (actor id, target id, fields changed) without leaking sensitive data.
- [x] Task 6: OpenAPI & Documentation
  - [x] Define request/response schemas for profile and context endpoints.
  - [x] Annotate endpoints with auth requirements and error responses.
  - [x] Publish OpenAPI to repo and ensure CI validates schema.
- [x] Task 7: Testing
  - [x] Integration tests for happy paths and RBAC enforcement.
  - [x] Negative tests for invalid input, forbidden access, and not found.
  - [x] Contract tests asserting `UserContext` schema stability.

## Dev Notes

### Driving Requirements
- Core user profile management and cross-service user context are foundational capabilities for the platform.
- Aligns with Access Control (RBAC) and Integration Requirements for inter-service data consumption.

*Source: `docs/prd/requirements.md`, `docs/prd/integration-requirements.md`*

### Architectural Guidance
- Work resides in `roguelearn-api` under the `UserService` project.
- Leverage the shared JWT validation middleware from Story 1.2.
- Respect data ownership boundaries; `UserService` is the source of truth for user profile and role relationships, and exposes normalized context to other services.

*Source: `docs/fullstack-architecture/backend-architecture.md`, `docs/fullstack-architecture/api-specification.md`*

### Data & Storage
- Profile and roles data from `user_profiles`, `roles`, and `user_roles`.
- Context aggregates read-only data from academic/class tables, skills, achievements, and enrollments when needed for summary fields.
- Avatars stored in Supabase Storage bucket `avatars` and referenced via `avatar_url` in profile.

*Source: `docs/fullstack-architecture/service-databases/user-service-database.md`*

### Security & Error Handling
- Only the authenticated user can update their own profile; admins can read other profiles.
- Validate inputs and return friendly error messages following PRD guidelines.

*Source: `docs/prd/error-handling.md`*

### Testing Strategy
- Integration tests using WebApplicationFactory and TestContainers for PostgreSQL.
- Contract tests ensure `UserContext` remains stable for cross-service clients.

*Source: `docs/prd/technical-guidance.md`*

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| [Current Date] | 1.0 | Initial story draft | Bob, SM |

## Dev Agent Record

### Agent Model Used
_TBD by Dev Agent_

### Debug Log References
_TBD by Dev Agent_

### Completion Notes List
_TBD by Dev Agent_

### File List
_TBD by Dev Agent_

## QA Results
_TBD by QA Agent_