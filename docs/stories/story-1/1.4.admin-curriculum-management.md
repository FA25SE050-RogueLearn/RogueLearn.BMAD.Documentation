# **Story 1.4: Admin - Curriculum Management Foundation**

## Status

Draft

## Story

**As a** Game Master (Admin),
**I want** to create and manage the core academic structures like Programs, Subjects, and Curriculum Versions via API endpoints,
**so that** I can provide the foundational data required for the student onboarding process and quest generation.

## Acceptance Criteria

1. A set of protected API endpoints are created that are only accessible by users with the 'Admin' role ('Game Master').
2. An admin can create, read, update, and delete `curriculum_programs` (e.g., "Bachelor of Software Engineering").
3. An admin can create, read, update, and delete `subjects` (e.g., "PRF192 - Programming Fundamentals").
4. An admin can create and manage `curriculum_versions` for a specific program (e.g., "K18A," "2024-Catalog").
5. An admin can associate subjects with a specific curriculum version, defining the `curriculum_structure` (e.g., add "PRF192" to the "K18A" version for term 1).
6. All API endpoints must enforce role-based access control (RBAC), returning a `403 Forbidden` error if accessed by a non-admin user.
7. The implementation must include xUnit integration tests to verify the functionality and security of each new endpoint.

## Tasks / Subtasks

- [ ] **Task 1: Implement Role-Based Authorization** (AC: #1, #6)
    - [ ] In the `roguelearn-api` solution, create or enhance a shared authorization handler/policy that checks if the authenticated user's JWT contains the 'Admin' role claim.
- [ ] **Task 2: Create Endpoints for Curriculum Programs** (AC: #2)
    - [ ] In the `UserService`, create a new `CurriculumProgramsController`.
    - [ ] Implement `GET /api/admin/curriculum-programs` to list all programs.
    - [ ] Implement `POST /api/admin/curriculum-programs` to create a new program.
    - [ ] Implement `PUT /api/admin/curriculum-programs/{id}` to update a program.
    - [ ] Implement `DELETE /api/admin/curriculum-programs/{id}` to delete a program.
    - [ ] Secure all endpoints with the 'Admin' role policy.
- [ ] **Task 3: Create Endpoints for Subjects** (AC: #3)
    - [ ] In the `UserService`, create a new `SubjectsController`.
    - [ ] Implement `GET /api/admin/subjects` and `POST /api/admin/subjects` (and optional PUT/DELETE).
    - [ ] Secure all endpoints with the 'Admin' role policy.
- [ ] **Task 4: Create Endpoints for Curriculum Versions & Structure** (AC: #4, #5)
    - [ ] In a new `CurriculumVersionsController`, implement endpoints to manage versions for a given program (e.g., `GET /api/admin/curriculum-programs/{programId}/versions`).
    - [ ] Implement an endpoint to associate subjects with a version, creating records in the `curriculum_structure` table (e.g., `POST /api/admin/curriculum-versions/{versionId}/subjects`).
    - [ ] Secure all endpoints with the 'Admin' role policy.
- [ ] **Task 5: Write Integration Tests** (AC: #7)
    - [ ] Create a new test suite for all the admin curriculum endpoints.
    - [ ] Write tests to verify that an admin user can successfully perform all CRUD operations.
    - [ ] Write tests to verify that a non-admin user receives a `403 Forbidden` error when attempting to access any of these endpoints.

## Dev Notes

### **Driving Requirement**
This story directly implements the foundational backend capabilities outlined in **FR53 (Admin-Owned University Curriculum Import & Administration)**. The focus is on creating the manual API endpoints first, which will be used by an admin UI in the future.

*Source: `docs/prd/requirements.md`*

### **Architectural Guidance**
*   **Repository**: All work for this story will be done within the **`roguelearn-api`** .NET solution. This is a backend-only story.
*   **Service**: The logical location for these academic structure endpoints is the **`UserService`**, as it owns the core user profile and their associated academic context.
*   **Database Tables**: This story will involve creating C# Entity Framework models and performing CRUD operations on the following tables: `curriculum_programs`, `subjects`, `curriculum_versions`, and `curriculum_structure`.

*Source: `docs/fullstack-architecture/database-schema.md`*

### **API Specification**
*   The endpoints created should follow the patterns defined in the OpenAPI specification for the admin-level endpoints. For example: `POST /admin/curriculum/import`, `GET /admin/curriculum/versions`, etc. Please adhere to this convention.
*   **Security**: This is the first story to implement true role-based access. The JWT validation middleware from Story 1.2 should be extended to check for a specific role claim (e.g., `"role": "Admin"`). All endpoints in the new admin controllers must be decorated with `[Authorize(Roles = "Admin")]`.

*Source: `docs/fullstack-architecture/api-specification.md`*

### **Prerequisite for Onboarding**
Completing this story is a **blocker** for the user-facing onboarding story. The `GET` endpoints created here will be consumed by the onboarding wizard to populate the dropdowns for "Route" and "Class" selection.

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| [Current Date] | 1.0 | Initial story draft, focusing on admin-first backend capabilities. | Bob, SM |

## Dev Agent Record

### Agent Model Used
_TBD by Dev Agent_

### Debug Log References
_TBD by Dev Agent_

### Completion Notes List
_TBD by Dev Agent_

### File List
_TBD by Dev Agent_

## QA Results
_TBD by QA Agent_