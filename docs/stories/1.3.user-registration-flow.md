# RougeLearn.BMAD.Documentation/docs/stories/1.3.user-registration-flow.md
# **Story 1.3: User Registration Flow**

## Status

Approved

## Story

**As a** prospective player,
**I want** to create an account with email verification,
**so that** I can access the RogueLearn platform securely.

## Acceptance Criteria

1. The registration form must validate email format and password strength (min. 8 characters, including mixed case and numbers).
2. The system must require email verification before a new account is fully activated.
3. The system must prevent registration with an email address that is already in use and display a clear, user-friendly error message.
4. The user must be required to accept the User Agreement and Privacy Policy before completing registration.
5. A successful registration must trigger a welcome email to the user, containing instructions for email verification.
6. All registration attempts (both successful and failed) must be logged for security monitoring purposes.

## Tasks / Subtasks

- [ ] **Task 1: Create Registration UI Component** (AC: #1, #4)
    - [ ] Create a new Next.js page component at `roguelearn-web/src/app/signup/page.tsx`.
    - [ ] Build a form using Shadcn/UI components (`Card`, `Input`, `Button`, `Checkbox`, `Label`).
    - [ ] Implement client-side validation for the email field to ensure a valid format.
    - [ ] Implement client-side validation for the password field to enforce strength requirements.
    - [ ] Add a mandatory checkbox for accepting the "User Agreement and Privacy Policy."
- [ ] **Task 2: Implement Client-Side Registration Logic** (AC: #2, #3, #5)
    - [ ] In the registration component, implement the `onSubmit` handler.
    - [ ] Call the Supabase `signUp` method from `@supabase/auth-helpers-nextjs` with the user's email, password, and metadata (username, first_name, last_name).
    - [ ] Handle the response from Supabase:
        - On success, display a message instructing the user to check their email to verify their account.
        - On failure (e.g., email already in use), display the appropriate user-friendly error message returned from Supabase.
- [ ] **Task 3: Configure Welcome Email and Verification** (AC: #2, #5)
    - [ ] In the Supabase dashboard, ensure the "Email Verification" feature is enabled.
    - [ ] Customize the Supabase email template for verification to match the RogueLearn branding and tone.
    - [ ] Confirm that the welcome email provides a clear call-to-action for the user to verify their email address.
- [ ] **Task 4: Implement Server-Side Logging** (AC: #6)
    - [ ] In the `roguelearn-api` solution, within the `UserService`, add logging logic to the `handle_new_user` trigger function (or a related process) to log the creation of a new user profile.
    - [ ] Although registration is handled by Supabase directly, ensure backend logging is in place to capture the event when the new user profile is created in our public schema.
- [ ] **Task 5: Write Tests**
    - [ ] Write unit tests for the registration UI component, mocking the Supabase client and testing form validation logic.
    - [ ] Write an integration or end-to-end test using Playwright to simulate the full registration flow, including checking for the success message.

## Dev Notes

### **Relevant Architecture & Business Rules**
*   **Authentication Provider**: All authentication logic MUST be handled via the Supabase Auth client SDK. Do not send user credentials to our backend. The backend's role is only to validate the JWT that Supabase provides after a successful login. [Source: `docs/fullstack-architecture/high-level-architecture.md`]
*   **User Synchronization**: A new user signing up via Supabase will automatically trigger the `handle_new_user` PostgreSQL function created in Story 1.2. This function is responsible for creating a corresponding entry in our public `user_profiles` table. This story must ensure the client-side sign-up passes the necessary metadata (`username`, `first_name`, `last_name`) for that trigger to work correctly. [Source: `docs/stories/1.2.authentication-service-integration.md`]
*   **UI Components**: All UI elements MUST be built using the pre-configured **Shadcn/UI** library to maintain design consistency. [Source: `docs/front-end-spec.md`]
*   **Error Handling**: User-facing error messages should be clear and helpful, abstracting away technical details. For example, instead of "unique constraint violation," display "An account with this email already exists." [Source: `docs/prd/error-handling.md`]
*   **Relevant Files**:
    *   `roguelearn-web/src/app/signup/page.tsx` (to be created)
    *   Supabase Dashboard: Auth > Email Templates
    *   `roguelearn-api/UserService/` (for reviewing logging related to the DB trigger)

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| [Current Date] | 1.0 | Initial story draft | Bob, SM |

## Dev Agent Record

### Agent Model Used
_TBD by Dev Agent_

### Debug Log References
_TBD by Dev Agent_

### Completion Notes List
_TBD by Dev Agent_

### File List
_TBD by Dev Agent_

## QA Results
_TBD by QA Agent_