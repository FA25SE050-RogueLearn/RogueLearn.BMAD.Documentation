# Story 4.1: Implement Party Management API (Create, Invite, Join, Leave)

## Status

Draft

## Ownership

* **Primary Owner (Social Service):** Minh Anh / An
* **Secondary Owner (Auth Integration):** Duong

## Target Deadline

Thursday, 30/10/2025

## Story

**As a** Player,
**I want** to create and manage small parties for cooperative quests (invite, join, leave),
**so that** I can team up with friends and participate in party-based activities.

## Acceptance Criteria

1. A new Party domain is added to the Social Service with the following entities: `Party` (id, name, leaderId, inviteCode, createdAt), `PartyMember` (partyId, userId, role: Leader|Member, joinedAt).
2. Endpoints in Social Service (secured with JWT):
   - `POST /api/parties` — Creates a party. The authenticated user becomes the `Leader`.
   - `POST /api/parties/{partyId}/invite` — Generates or rotates an `inviteCode`; returns the code. Only `Leader` can invoke.
   - `POST /api/parties/join` — Accepts `inviteCode` to join a party. Prevent duplicate membership.
   - `POST /api/parties/{partyId}/leave` — Authenticated user leaves the party; if the leader leaves, ownership transfers to the oldest member or the party is dissolved if empty.
   - `GET /api/parties/{partyId}` — Returns party details, members, and roles.
3. Authorization rules:
   - Only the party `Leader` can generate/rotate invite code and remove members.
   - Members can leave anytime.
   - Attempts to join a full party are rejected with 409 (size limit configurable, default 5).
4. Persistence: Party data stored in Social Service database with proper foreign keys and unique constraints (`unique(inviteCode)`, `unique(partyId,userId)`).
5. OpenAPI documentation updated for all endpoints with request/response schemas.
6. Integration tests cover: create, invite, join (valid/invalid code), duplicate join prevention, leave, leader transfer, and size limit enforcement.

## Tasks / Subtasks

- [ ] Task 1: Define Party Domain Model and Migrations (AC: #1, #4)
  - [ ] Create `Party` and `PartyMember` tables with indexes and constraints.
  - [ ] Add unique constraint for `inviteCode` and composite unique on `(partyId,userId)`.
- [ ] Task 2: Implement Party Service and Repository (AC: #1, #4)
  - [ ] CRUD for Party and membership operations (create, inviteCode rotate, join, leave, transfer leadership).
- [ ] Task 3: Build Party Controller Endpoints (AC: #2, #3)
  - [ ] Implement endpoints with `[Authorize]` and role checks for Leader actions.
- [ ] Task 4: Add OpenAPI Specs (AC: #5)
  - [ ] Document endpoints, request/response models, and error cases (409 for full party, 403 for unauthorized actions).
- [ ] Task 5: Integration Tests (AC: #6)
  - [ ] Tests for create, invite, join with valid/invalid codes, duplicate join, leave, leader transfer, size limit.
- [ ] Task 6: Configurable Party Size Limit (AC: #3)
  - [ ] Add app config (e.g., `PartySettings:MaxMembers=5`), read via options pattern.