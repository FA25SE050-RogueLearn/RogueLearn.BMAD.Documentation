# Story 4.2: Implement Guild Management Core APIs (Create, Roles, Membership, Invitations)

## Status

Draft

## Ownership

* **Primary Owner (Social Service):** Minh Anh / An
* **Secondary Owner (Auth Integration):** Duong

## Target Deadline

Thursday, 30/10/2025

## Story

**As a** Guild Master,
**I want** core guild management features (create guild, manage roles, invite users, approve join requests, remove members),
**so that** I can organize my community and control membership and permissions within the guild.

## Acceptance Criteria

1. Guild domain added to Social Service with entities: `Guild` (id, name, tag, description, masterUserId, createdAt), `GuildMember` (guildId, userId, role: GuildMaster|Officer|Member, joinedAt), `GuildInvite` (guildId, inviteCode, createdBy, createdAt, expiresAt(optional)).
2. Endpoints in Social Service (secured with JWT):
   - `POST /api/guilds` — Creates a guild; authenticated user becomes `GuildMaster`.
   - `GET /api/guilds/{guildId}` — Returns guild details and member list with roles.
   - `POST /api/guilds/{guildId}/invites` — Creates or rotates an invite code. Only `GuildMaster` or `Officer` can invoke.
   - `POST /api/guilds/join` — Accepts `inviteCode` to join the specified guild; prevents duplicates; optional pending approval if policy requires.
   - `POST /api/guilds/{guildId}/members/{userId}/role` — Promotes/demotes between `Officer` and `Member`. Only `GuildMaster` can change roles.
   - `DELETE /api/guilds/{guildId}/members/{userId}` — Removes a member. Only `GuildMaster` or `Officer` can remove `Member`; removing `Officer` requires `GuildMaster`.
   - `POST /api/guilds/{guildId}/leave` — Authenticated user leaves; if `GuildMaster` leaves and there is no officer/member, the guild is dissolved; otherwise master transfers to the oldest `Officer` or oldest `Member`.
3. Authorization rules enforced:
   - `GuildMaster` can manage roles and remove any non-master member; cannot demote themselves without transfer.
   - `Officer` can invite and remove `Member`; cannot change roles.
   - `Member` can leave at any time.
4. Persistence with constraints:
   - Unique constraint on guild `tag` and optional invite `inviteCode`.
   - Composite unique `(guildId,userId)` for membership.
5. OpenAPI documentation updated with schemas and error responses.
6. Integration tests validate: create, invite flow, join, duplicate prevention, role changes, removal rules, leave and master transfer.

## Tasks / Subtasks

- [ ] Task 1: Define Guild Domain and Migrations (AC: #1, #4)
  - [ ] Tables for `Guild`, `GuildMember`, `GuildInvite` with keys and indexes (unique `tag`, unique `inviteCode`).
- [ ] Task 2: Implement Guild Services and Repositories (AC: #1, #4)
  - [ ] Role management, invite code lifecycle, membership CRUD, master transfer.
- [ ] Task 3: Build Guild Controller Endpoints (AC: #2, #3)
  - [ ] Implement endpoints with authorization attributes and role checks.
- [ ] Task 4: OpenAPI Specs (AC: #5)
  - [ ] Document endpoints, schemas, permissions, and error codes.
- [ ] Task 5: Integration Tests (AC: #6)
  - [ ] Tests for create, invite, join, duplicate prevention, role changes, removal rules, leave and master transfer.
- [ ] Task 6: Policy Hooks (Optional)
  - [ ] Add optional approval policy toggle: direct join via invite or require officer/master approval; expose as config.