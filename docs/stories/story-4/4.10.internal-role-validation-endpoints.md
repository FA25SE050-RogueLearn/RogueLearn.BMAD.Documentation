# Story 4.10: Internal Role Validation Endpoints (Social Service)

## Status

Draft

## Ownership

* **Primary Owner (Social Service):** Minh Anh / An
* **Secondary Consumers:** Event Service (Story 3.2), Other services needing S2S role checks

## Target Deadline

Thursday, 30/10/2025

## Story

**As a** Developer,
**I want** internal-only endpoints to validate Party and Guild roles,
**so that** other services can securely authorize cross-service operations.

## Acceptance Criteria

1. Endpoints (internal-only, not exposed on public gateway):
   - `GET /internal/parties/{partyId}/is-leader?userId=` — Returns boolean.
   - `GET /internal/guilds/{guildId}/role?userId=` — Returns role enum (`GuildMaster|Officer|Member|None`).
2. Security:
   - Only accessible via service-to-service authentication (e.g., internal token or mTLS). Reject public JWTs.
3. Performance & Logging:
   - Responses cached for short TTL (e.g., 60s) to reduce load.
   - Audit logs record caller service, party/guildId, userId, result.
4. Documentation & Tests:
   - Internal API docs (OpenAPI or markdown) with usage examples.
   - Integration tests with mocked S2S authentication.

## Tasks / Subtasks

- [ ] Task 1: Authentication Mechanism (AC: #2)
  - [ ] Implement S2S auth (internal token or mTLS), middleware to block public JWTs.
- [ ] Task 2: Endpoints Implementation (AC: #1)
  - [ ] Build role validation endpoints using existing Membership tables.
- [ ] Task 3: Caching & Logging (AC: #3)
  - [ ] Add short-lived cache layer and audit logging.
- [ ] Task 4: Docs & Tests (AC: #4)
  - [ ] Write internal API docs; add integration tests mocking S2S auth.