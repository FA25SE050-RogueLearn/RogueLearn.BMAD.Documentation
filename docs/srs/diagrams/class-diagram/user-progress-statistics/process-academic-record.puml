@startuml
skinparam linetype ortho
skinparam ranksep 50
skinparam nodesep 50
skinparam classAttributeIconSize 0
hide empty members

package "API Layer" {
    class UsersController {
        - _mediator : IMediator
        + ProcessMyAcademicRecord(fapHtmlContent, curriculumProgramId)
    }
}

package "Application Layer" {
    class ProcessAcademicRecordCommand {
        + AuthUserId : Guid
        + FapHtmlContent : string
        + CurriculumProgramId : Guid
    }

    class ProcessAcademicRecordHandler {
        + Handle(command, cancellationToken)
    }
    
    class ProcessAcademicRecordResponse {
        + IsSuccess : boolean
        + SubjectsProcessed : int
        + CalculatedGpa : double?
        + XpAwarded : XpAwardedSummary
    }

    interface IHtmlCleaningService {
        + ExtractCleanText(html)
    }

    interface IFapExtractionPlugin {
        + ExtractFapRecordJsonAsync(cleanText)
    }
    
    interface IGradeExperienceCalculator {
        + CalculateXpForGrade(grade)
    }
}

package "Domain & Infrastructure Layer" {
    class HtmlCleaningService
    class FapExtractionPlugin
    class GradeExperienceCalculator
    
    interface IStudentSemesterSubjectRepository
    interface IStudentEnrollmentRepository
    interface ISubjectRepository
    interface IUserSkillRepository
    interface IUserSkillRewardRepository
    
    class StudentSemesterSubject {
        + Status : string
        + Grade : string
        + CreditsEarned : int
    }
    
    class UserSkillReward {
        + PointsAwarded : int
        + Reason : string
    }
}

' Relationships
UsersController ..> ProcessAcademicRecordCommand : Creates
UsersController ..> ProcessAcademicRecordHandler : Sends via Mediator

ProcessAcademicRecordHandler ..> ProcessAcademicRecordCommand : Uses
ProcessAcademicRecordHandler ..> ProcessAcademicRecordResponse : Returns

ProcessAcademicRecordHandler --> IHtmlCleaningService
ProcessAcademicRecordHandler --> IFapExtractionPlugin
ProcessAcademicRecordHandler --> IGradeExperienceCalculator

ProcessAcademicRecordHandler --> IStudentSemesterSubjectRepository
ProcessAcademicRecordHandler --> IStudentEnrollmentRepository
ProcessAcademicRecordHandler --> ISubjectRepository
ProcessAcademicRecordHandler --> IUserSkillRepository
ProcessAcademicRecordHandler --> IUserSkillRewardRepository

IHtmlCleaningService <|.. HtmlCleaningService
IFapExtractionPlugin <|.. FapExtractionPlugin
IGradeExperienceCalculator <|.. GradeExperienceCalculator

IStudentSemesterSubjectRepository ..> StudentSemesterSubject : Persists
IUserSkillRewardRepository ..> UserSkillReward : Persists

@enduml