@startuml
title 3.20.1 Class Diagram - Submit Quest Step Feedback
skinparam linetype ortho
skinparam ranksep 60
skinparam nodesep 60
skinparam classAttributeIconSize 0
hide empty members

package "API Layer" {
    class QuestFeedbackController {
        +SubmitFeedback(questId, stepId, command)
    }
}

package "Application Layer" {
    class SubmitQuestStepFeedbackCommand {
        +AuthUserId: Guid
        +QuestId: Guid
        +StepId: Guid
        +Rating: int
        +Category: string
        +Comment: string
    }

    class SubmitQuestStepFeedbackCommandHandler {
        +Handle(command, cancellationToken)
    }

    class SubmitQuestStepFeedbackCommandValidator {
        +Validate(command)
    }
}

package "Domain & Infrastructure Layer" {
    class UserQuestStepFeedback {
        +Id: Guid
        +SubjectId: Guid
        +Category: string
        +IsResolved: bool
    }

    interface IQuestStepRepository {
        +GetByIdAsync(id)
    }

    interface IQuestRepository {
        +GetByIdAsync(id)
    }

    interface IUserQuestStepFeedbackRepository {
        +AddAsync(entity)
    }
}

' Formatting
QuestFeedbackController -[hidden]- SubmitQuestStepFeedbackCommandHandler

' Relationships
QuestFeedbackController ..> SubmitQuestStepFeedbackCommand : Creates
QuestFeedbackController ..> SubmitQuestStepFeedbackCommandHandler : Sends (Mediator)
SubmitQuestStepFeedbackCommand ..> SubmitQuestStepFeedbackCommandValidator : Validated By

SubmitQuestStepFeedbackCommandHandler --> IQuestStepRepository : Validates Step
SubmitQuestStepFeedbackCommandHandler --> IQuestRepository : Fetches SubjectId
SubmitQuestStepFeedbackCommandHandler --> IUserQuestStepFeedbackRepository : Persists

IUserQuestStepFeedbackRepository ..> UserQuestStepFeedback : Manages
@enduml