@startuml
actor Admin
participant AdminManagementUI as UI
participant ":AdminQuestsController" as Controller
participant ":IBackgroundJobClient" as JobQueue
participant ":IQuestStepGenerationService" as IService
participant ":QuestStepGenerationService" as Service
participant ":IMediator" as Med
participant ":GenerateQuestSteps\nCommandHandler" as Handler
participant ":ITopicGrouperService" as IGrouper
participant ":TopicGrouperService" as Grouper
participant ":IQuestGenerationPlugin" as IPlugin
participant ":QuestGenerationPlugin" as Plugin
participant ":IQuestStepRepository" as IStepRepo
participant ":QuestStepRepository" as StepRepo
database ":Database" as DB

Admin -> UI : Click "Generate Steps"
activate UI

UI -> Controller : POST /api/admin/quests/generate-steps
activate Controller

Controller -> JobQueue : Schedule(GenerateQuestStepsAsync)
activate JobQueue
JobQueue --> Controller : JobId
deactivate JobQueue

Controller --> UI : 202 Accepted (JobId)
deactivate Controller

UI --> Admin : Show "Generation Queued" Toast
deactivate UI

note right of JobQueue: Async Background Process

JobQueue -> IService : GenerateQuestStepsAsync()
activate IService
IService -> Service : GenerateQuestStepsAsync()
activate Service

Service -> Med : Send(GenerateQuestStepsCommand)
activate Med

Med -> Handler : Handle(command)
activate Handler

' 1. Group Syllabus
Handler -> IGrouper : GroupSessionsIntoModules(Syllabus)
activate IGrouper
IGrouper -> Grouper : GroupSessionsIntoModules(Syllabus)
activate Grouper
Grouper --> IGrouper : List<Module>
deactivate Grouper
IGrouper --> Handler : List<Module>
deactivate IGrouper

' 2. Generate Content
loop For Each Module
    Handler -> IPlugin : GenerateFromPromptAsync(Prompt)
    activate IPlugin
    IPlugin -> Plugin : GenerateFromPromptAsync(Prompt)
    activate Plugin
    note right
        Generates 3 Variants:
        Standard, Supportive, Challenging
    end note
    Plugin --> IPlugin : JSON Content
    deactivate Plugin
    IPlugin --> Handler : JSON Content
    deactivate IPlugin

    Handler -> Handler : Create 3 QuestSteps
    
    Handler -> IStepRepo : AddRangeAsync(Steps)
    activate IStepRepo
    IStepRepo -> StepRepo : AddRangeAsync(Steps)
    activate StepRepo
    StepRepo -> DB : INSERT INTO quest_steps...
    activate DB
    DB --> StepRepo : Success
    deactivate DB
    StepRepo --> IStepRepo : Success
    deactivate StepRepo
    IStepRepo --> Handler : Success
    deactivate IStepRepo
end

Handler --> Med : Success
deactivate Handler
Med --> Service : Success
deactivate Med

Service --> IService : Success
deactivate Service
IService --> JobQueue : Success
deactivate IService
@enduml