' generate-quest-steps-seq.puml
@startuml
actor Admin
participant "AdminConsole" as UI
participant "QuestsController" as Controller
participant "Hangfire" as JobQueue
participant "QuestStepGeneration\nService" as Service
participant "TopicGrouper" as Grouper
participant "QuestGeneration\nPlugin (AI)" as AI
participant "Database" as DB

Admin -> UI : 1. Click "Generate Steps"
UI -> Controller : 2. POST /api/quests/{id}/generate-steps
Controller -> JobQueue : 3. Schedule(GenerateQuestStepsAsync)
JobQueue --> Controller : JobId
Controller --> UI : 4. 202 Accepted (JobId)

note right of JobQueue: Async Background Process

JobQueue -> Service : 5. Execute GenerateQuestStepsAsync

activate Service
    Service -> DB : 6. GetQuestById(questId)
    DB --> Service : quest (with Subject/Syllabus)

    Service -> Grouper : 7. GroupSessionsIntoModules(syllabus)
    Grouper --> Service : modules (List of Topics)

    loop For each Module
        Service -> AI : 8. GenerateWeeklyContentAsync(topic, syllabus)
        note right: Calls Gemini to generate\nStandard, Supportive, Challenging tracks
        AI --> Service : contentJson (3 variants)

        Service -> Service : 9. Create 3 QuestStep entities
        note right: Map JSON to DifficultyVariant:\nStandard, Supportive, Challenging
    end

    Service -> DB : 10. AddRangeAsync(newSteps)
    DB --> Service : Success
deactivate Service

UI -> Controller : 11. Poll Status (JobId)
Controller -> JobQueue : Check Status
JobQueue --> Controller : Succeeded
Controller --> UI : 12. Show "Generation Complete"
@enduml