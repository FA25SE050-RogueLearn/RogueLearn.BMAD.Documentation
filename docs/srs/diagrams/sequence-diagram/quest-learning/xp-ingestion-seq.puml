@startuml
actor User
participant SystemManagementUI as UI
participant ":UserSkillsController" as Controller
participant ":IMediator" as Med
participant ":IngestXpEvent\nCommandHandler" as Handler
participant ":IUserSkillReward\nRepository" as IRewardRepo
participant ":UserSkillReward\nRepository" as RewardRepo
participant ":ISkillRepository" as ISkillRepo
participant ":SkillRepository" as SkillRepo
participant ":IUserSkillRepository" as IUserSkillRepo
participant ":UserSkillRepository" as UserSkillRepo
database ":Database" as DB

User -> UI : Perform Action (e.g., Claim XP)
activate UI

UI -> Controller : POST /api/users/skills/xp
activate Controller

Controller -> Med : Send(IngestXpEventCommand)
activate Med

Med -> Handler : Handle(command)
activate Handler

' 1. Idempotency Check
Handler -> IRewardRepo : GetBySourceAndSkillAsync(UserId, SourceId, SkillId)
activate IRewardRepo
IRewardRepo -> RewardRepo : GetBySourceAndSkillAsync(...)
activate RewardRepo
' Analyzed: Matches user_skill_rewards table columns
RewardRepo -> DB : SELECT * FROM user_skill_rewards \nWHERE auth_user_id = @UserId \nAND source_id = @SourceId AND skill_id = @SkillId
activate DB
DB --> RewardRepo : ExistingReward?
deactivate DB
RewardRepo --> IRewardRepo : ExistingReward?
deactivate RewardRepo
IRewardRepo --> Handler : ExistingReward?
deactivate IRewardRepo

alt Already Processed
    Handler --> Med : Response (Processed=false)
else New Event
    ' 2. Validate Skill
    Handler -> ISkillRepo : GetByIdAsync(SkillId)
    activate ISkillRepo
    ISkillRepo -> SkillRepo : GetByIdAsync(SkillId)
    activate SkillRepo
    ' Analyzed: Matches skills table
    SkillRepo -> DB : SELECT * FROM skills WHERE id = @SkillId
    activate DB
    DB --> SkillRepo : Skill
    deactivate DB
    SkillRepo --> ISkillRepo : Skill
    deactivate SkillRepo
    ISkillRepo --> Handler : Skill
    deactivate ISkillRepo

    ' 3. Record History
    Handler -> IRewardRepo : AddAsync(UserSkillReward)
    activate IRewardRepo
    IRewardRepo -> RewardRepo : AddAsync(Reward)
    activate RewardRepo
    ' Analyzed: Inserts audit log into user_skill_rewards
    RewardRepo -> DB : INSERT INTO user_skill_rewards \n(auth_user_id, source_service, source_type, source_id, skill_id, points_awarded...)
    activate DB
    DB --> RewardRepo : Success
    deactivate DB
    RewardRepo --> IRewardRepo : Success
    deactivate RewardRepo
    IRewardRepo --> Handler : Success
    deactivate IRewardRepo

    ' 4. Update User Progress
    Handler -> IUserSkillRepo : FirstOrDefaultAsync(UserId, SkillId)
    activate IUserSkillRepo
    IUserSkillRepo -> UserSkillRepo : FirstOrDefaultAsync(...)
    activate UserSkillRepo
    ' Analyzed: Matches user_skills table
    UserSkillRepo -> DB : SELECT * FROM user_skills \nWHERE auth_user_id = @UserId AND skill_id = @SkillId
    activate DB
    DB --> UserSkillRepo : UserSkill?
    deactivate DB
    UserSkillRepo --> IUserSkillRepo : UserSkill?
    deactivate UserSkillRepo
    IUserSkillRepo --> Handler : UserSkill?
    deactivate IUserSkillRepo

    alt Skill Not Started
        Handler -> Handler : Create New UserSkill
        Handler -> IUserSkillRepo : AddAsync(NewUserSkill)
        activate IUserSkillRepo
        IUserSkillRepo -> UserSkillRepo : AddAsync(...)
        activate UserSkillRepo
        ' Analyzed: First time earning this skill
        UserSkillRepo -> DB : INSERT INTO user_skills (auth_user_id, skill_id, experience_points, level...)
        activate DB
        DB --> UserSkillRepo : Success
        deactivate DB
        UserSkillRepo --> IUserSkillRepo : Success
        deactivate UserSkillRepo
        IUserSkillRepo --> Handler : Success
        deactivate IUserSkillRepo
    else Skill Exists
        Handler -> Handler : Add XP
        Handler -> Handler : CalculateLevel(TotalXP)
        Handler -> IUserSkillRepo : UpdateAsync(UserSkill)
        activate IUserSkillRepo
        IUserSkillRepo -> UserSkillRepo : UpdateAsync(...)
        activate UserSkillRepo
        ' Analyzed: Update existing skill progress
        UserSkillRepo -> DB : UPDATE user_skills SET experience_points = ..., level = ... \nWHERE id = @Id
        activate DB
        DB --> UserSkillRepo : Success
        deactivate DB
        UserSkillRepo --> IUserSkillRepo : Success
        deactivate UserSkillRepo
        IUserSkillRepo --> Handler : Success
        deactivate IUserSkillRepo
    end

    Handler --> Med : IngestXpEventResponse
end

deactivate Handler
Med --> Controller : Response
deactivate Med

Controller --> UI : 200 OK (XP Updated)
deactivate Controller

UI -> UI : Animate XP Bar
UI --> User : Show Level Up Popup (if applicable)
deactivate UI
@enduml