@startuml
actor User
participant ":QuestsController" as Controller
participant ":IMediator" as Med
participant ":SubmitQuizAnswer\nCommandHandler" as Handler
participant ":IQuestRepository" as IQuestRepo
participant ":QuestRepository" as QuestRepo
participant ":IQuestStepRepository" as IStepRepo
participant ":QuestStepRepository" as StepRepo
participant ":IUserQuestAttempt\nRepository" as IAttemptRepo
participant ":UserQuestAttempt\nRepository" as AttemptRepo
participant ":IQuizValidationService" as IValidator
participant ":QuizValidationService" as Validator
participant ":IQuestSubmission\nRepository" as ISubmissionRepo
participant ":QuestSubmission\nRepository" as SubmissionRepo
participant ":IUserQuestStepProgress\nRepository" as IProgressRepo
participant ":UserQuestStepProgress\nRepository" as ProgressRepo
database ":Database" as DB

User -> Controller : Submit Quiz Answers
activate Controller

Controller -> Med : Send(SubmitQuizAnswerCommand)
activate Med

Med -> Handler : Handle(command)
activate Handler

' 1. Validate Context
Handler -> IQuestRepo : GetByIdAsync(QuestId)
activate IQuestRepo
IQuestRepo -> QuestRepo : GetByIdAsync(QuestId)
activate QuestRepo
QuestRepo -> DB : SELECT * FROM quests...
activate DB
DB --> QuestRepo : Quest
deactivate DB
QuestRepo --> IQuestRepo : Quest
deactivate QuestRepo
IQuestRepo --> Handler : Quest
deactivate IQuestRepo

Handler -> IStepRepo : GetByIdAsync(StepId)
activate IStepRepo
IStepRepo -> StepRepo : GetByIdAsync(StepId)
activate StepRepo
StepRepo -> DB : SELECT * FROM quest_steps...
activate DB
DB --> StepRepo : Step
deactivate DB
StepRepo --> IStepRepo : Step
deactivate StepRepo
IStepRepo --> Handler : Step
deactivate IStepRepo

' 2. Get/Create Attempt
Handler -> IAttemptRepo : FirstOrDefaultAsync(UserId, QuestId)
activate IAttemptRepo
IAttemptRepo -> AttemptRepo : FirstOrDefaultAsync(UserId, QuestId)
activate AttemptRepo
AttemptRepo -> DB : SELECT * FROM user_quest_attempts...
activate DB
DB --> AttemptRepo : Attempt
deactivate DB
AttemptRepo --> IAttemptRepo : Attempt
deactivate AttemptRepo
IAttemptRepo --> Handler : Attempt
deactivate IAttemptRepo

' 3. Evaluate
Handler -> IValidator : EvaluateQuizSubmission(Correct, Total)
activate IValidator
IValidator -> Validator : EvaluateQuizSubmission(Correct, Total)
activate Validator
Validator --> IValidator : (IsPassed, Score%)
deactivate Validator
IValidator --> Handler : (IsPassed, Score%)
deactivate IValidator

' 4. Record Submission
Handler -> ISubmissionRepo : AddAsync(QuestSubmission)
activate ISubmissionRepo
ISubmissionRepo -> SubmissionRepo : AddAsync(QuestSubmission)
activate SubmissionRepo
SubmissionRepo -> DB : INSERT INTO quest_submissions...
activate DB
DB --> SubmissionRepo : Success
deactivate DB
SubmissionRepo --> ISubmissionRepo : CreatedSubmission
deactivate SubmissionRepo
ISubmissionRepo --> Handler : CreatedSubmission
deactivate ISubmissionRepo

' 5. Update Progress (If Passed)
alt IsPassed
    Handler -> IProgressRepo : GetByAttemptAndStepAsync(AttemptId, StepId)
    activate IProgressRepo
    IProgressRepo -> ProgressRepo : GetByAttemptAndStepAsync(AttemptId, StepId)
    activate ProgressRepo
    ProgressRepo -> DB : SELECT...
    activate DB
    DB --> ProgressRepo : Progress
    deactivate DB
    ProgressRepo --> IProgressRepo : Progress
    deactivate ProgressRepo
    IProgressRepo --> Handler : Progress
    deactivate IProgressRepo

    Handler -> Handler : Update Status = Completed
    Handler -> IProgressRepo : UpdateAsync(Progress)
    activate IProgressRepo
    IProgressRepo -> ProgressRepo : UpdateAsync(Progress)
    activate ProgressRepo
    ProgressRepo -> DB : UPDATE...
    activate DB
    DB --> ProgressRepo : Success
    deactivate DB
    ProgressRepo --> IProgressRepo : Success
    deactivate ProgressRepo
    IProgressRepo --> Handler : Success
    deactivate IProgressRepo
    
    Handler -> Handler : Distribute XP (via Mediator/IngestXpEvent)
end

Handler --> Med : SubmitQuizAnswerResponse
deactivate Handler

Med --> Controller : Response
deactivate Med

Controller --> User : 200 OK (Score & Result)
deactivate Controller
@enduml