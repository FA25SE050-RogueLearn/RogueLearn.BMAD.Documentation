' quiz-submission-seq.puml
@startuml
actor User
participant "Frontend UI" as UI
participant "QuestsController" as Controller
participant "SubmitQuizAnswer\nHandler" as Handler
participant "UserQuestStep\nProgressRepo" as ProgressRepo
participant "QuestSubmission\nRepo" as SubmissionRepo
participant "UserSkillReward\nRepo" as XpRepo
participant "Database" as DB

User -> UI : 1. Submit Quiz Answers
UI -> Controller : 2. POST /api/quests/{qid}/steps/{sid}/activities/{aid}/submit-quiz
Controller -> Handler : 3. Handle(SubmitQuizAnswerCommand)

activate Handler
    Handler -> Handler : 4. Calculate Score (Correct/Total)
    
    Handler -> ProgressRepo : 5. GetByAttemptAndStepAsync()
    ProgressRepo --> Handler : stepProgress
    
    Handler -> SubmissionRepo : 6. AddAsync(new QuestSubmission)
    SubmissionRepo -> DB : INSERT QuestSubmissions...
    
    alt Score >= Passing Threshold (e.g. 70%)
        Handler -> ProgressRepo : 7. UpdateCompletedActivities(activityId)
        note right: Adds ActivityId to\nCompletedActivityIds list
        ProgressRepo -> DB : UPDATE UserQuestStepProgress...
        
        Handler -> XpRepo : 8. AddAsync(new UserSkillReward)
        note right: Awards XP for this specific activity
        XpRepo -> DB : INSERT UserSkillRewards...
    end
    
    Handler --> Controller : 9. Return Response (Passed/Failed, Score)
deactivate Handler

Controller --> UI : 10. 200 OK
UI --> User : 11. Show Result & XP Gain
@enduml