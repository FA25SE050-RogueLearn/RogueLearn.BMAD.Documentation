@startuml
actor User
participant QuestManagementUI as UI
participant ":QuestsController" as Controller
participant ":IMediator" as Med
participant ":StartQuestCommandHandler" as Handler
participant ":IQuestRepository" as IQuestRepo
participant ":QuestRepository" as QuestRepo
participant ":IUserQuestAttemptRepository" as IAttemptRepo
participant ":UserQuestAttemptRepository" as AttemptRepo
database ":Database" as DB

User -> UI : Click "Start Quest"
activate UI

UI -> Controller : POST /api/quests/{id}/start
activate Controller

Controller -> Med : Send(StartQuestCommand)
activate Med

Med -> Handler : Handle(command)
activate Handler

' 1. Validate Quest
Handler -> IQuestRepo : GetByIdAsync(QuestId)
activate IQuestRepo
IQuestRepo -> QuestRepo : GetByIdAsync(QuestId)
activate QuestRepo
' Analyzed: Matches quests table
QuestRepo -> DB : SELECT * FROM quests WHERE id = @QuestId
activate DB
DB --> QuestRepo : Quest Entity
deactivate DB
QuestRepo --> IQuestRepo : Quest Entity
deactivate QuestRepo
IQuestRepo --> Handler : Quest Entity
deactivate IQuestRepo

alt Quest Found
    ' 2. Check Existing Attempt
    Handler -> IAttemptRepo : FirstOrDefaultAsync(UserId, QuestId)
    activate IAttemptRepo
    IAttemptRepo -> AttemptRepo : FirstOrDefaultAsync(UserId, QuestId)
    activate AttemptRepo
    ' Analyzed: Checks user_quest_attempts for duplicates
    AttemptRepo -> DB : SELECT * FROM user_quest_attempts \nWHERE auth_user_id = @UserId AND quest_id = @QuestId
    activate DB
    DB --> AttemptRepo : ExistingAttempt?
    deactivate DB
    AttemptRepo --> IAttemptRepo : ExistingAttempt?
    deactivate AttemptRepo
    IAttemptRepo --> Handler : ExistingAttempt?
    deactivate IAttemptRepo

    alt Attempt Not Found
        ' 3. Create New Attempt
        Handler -> Handler : Create UserQuestAttempt
        note right
            Status = "InProgress" (enum)
            AssignedDifficulty = Quest.expected_difficulty
            StartedAt = UtcNow
        end note

        Handler -> IAttemptRepo : AddAsync(NewAttempt)
        activate IAttemptRepo
        IAttemptRepo -> AttemptRepo : AddAsync(NewAttempt)
        activate AttemptRepo
        ' Analyzed: Inserts new record
        AttemptRepo -> DB : INSERT INTO user_quest_attempts \n(id, auth_user_id, quest_id, status, assigned_difficulty, started_at...)
        activate DB
        DB --> AttemptRepo : CreatedAttempt
        deactivate DB
        AttemptRepo --> IAttemptRepo : CreatedAttempt
        deactivate AttemptRepo
        IAttemptRepo --> Handler : CreatedAttempt
        deactivate IAttemptRepo
        
        Handler --> Med : Response (IsNew=true)
    else Attempt Found
        Handler --> Med : Response (IsNew=false)
    end
else Quest Not Found
    Handler --> Med : Throw NotFoundException
end

deactivate Handler

Med --> Controller : Result
deactivate Med

Controller --> UI : 200 OK
deactivate Controller

UI -> UI : Change Button to "Continue"
UI --> User : Open Quest View
deactivate UI
@enduml