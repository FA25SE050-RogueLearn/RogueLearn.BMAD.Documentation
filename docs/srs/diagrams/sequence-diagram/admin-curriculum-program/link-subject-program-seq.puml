@startuml
actor Admin
participant ":CurriculumProgramSubjects\nController" as Controller
participant ":IMediator" as Med
participant ":AddSubjectToProgram\nCommandHandler" as Handler
participant ":ICurriculumProgram\nRepository" as ProgRepo
participant ":ISubjectRepository" as SubRepo
participant ":ICurriculumProgramSubject\nRepository" as LinkRepo
database ":Database" as DB

Admin -> Controller : POST /programs/{pid}/subjects
activate Controller

Controller -> Med : Send(AddSubjectToProgramCommand)
activate Med

Med -> Handler : Handle(command)
activate Handler

' 1. Validate Parents
Handler -> ProgRepo : ExistsAsync(ProgramId)
alt Program Not Found
    Handler --> Med : Throw NotFoundException
end

Handler -> SubRepo : ExistsAsync(SubjectId)
alt Subject Not Found
    Handler --> Med : Throw NotFoundException
end

' 2. Check Existing Link
Handler -> LinkRepo : AnyAsync(ProgramId, SubjectId)
activate LinkRepo
LinkRepo -> DB : SELECT 1...
DB --> LinkRepo : Exists?
deactivate LinkRepo

alt Link Exists
    Handler --> Med : Throw ConflictException
else New Link
    ' 3. Create Link
    Handler -> LinkRepo : AddAsync(NewLink)
    activate LinkRepo
    LinkRepo -> DB : INSERT...
    DB --> LinkRepo : Success
    deactivate LinkRepo
    
    Handler --> Med : AddSubjectToProgramResponse
end

deactivate Handler
Med --> Controller : Response
deactivate Med

Controller --> Admin : 201 Created
deactivate Controller
@enduml