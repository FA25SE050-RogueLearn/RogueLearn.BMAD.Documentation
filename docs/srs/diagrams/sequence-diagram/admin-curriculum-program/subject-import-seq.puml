@startuml
actor Admin
participant ":SubjectsController" as Controller
participant ":IMediator" as Med
participant ":ImportSubjectFromText\nCommandHandler" as Handler
participant ":IHtmlCleaningService" as Cleaner
participant ":ISyllabusExtractionPlugin" as Plugin
participant ":IAiQueryClassificationService" as QuerySvc
participant ":IReadingUrlService" as UrlSvc
participant ":ISubjectRepository" as Repo
database ":Database" as DB

Admin -> Controller : POST /api/admin/subjects/import-from-text
activate Controller

Controller -> Med : Send(ImportSubjectFromTextCommand)
activate Med

Med -> Handler : Handle(command)
activate Handler

' 1. Clean & Extract
Handler -> Cleaner : ExtractCleanTextFromHtml(RawText)
activate Cleaner
Cleaner --> Handler : CleanText
deactivate Cleaner

Handler -> Plugin : ExtractSyllabusJsonAsync(CleanText)
activate Plugin
note right: Calls Gemini AI
Plugin --> Handler : Syllabus JSON
deactivate Plugin

Handler -> Handler : Deserialize to SyllabusData

' 2. URL Enrichment
group URL Enrichment
    Handler -> QuerySvc : GenerateBatchQueryVariantsAsync(Sessions)
    activate QuerySvc
    QuerySvc --> Handler : Query Variants
    deactivate QuerySvc

    loop For Each Session
        Handler -> UrlSvc : GetValidUrlForTopicAsync()
        activate UrlSvc
        UrlSvc --> Handler : Validated URL
        deactivate UrlSvc
        Handler -> Handler : Update Session Data
    end
end

' 3. Persist
Handler -> Repo : FirstOrDefaultAsync(SubjectCode)
activate Repo
Repo -> DB : SELECT * FROM subjects...
DB --> Repo : ExistingSubject?
deactivate Repo

alt Exists
    Handler -> Repo : UpdateAsync(UpdatedSubject)
    activate Repo
    Repo -> DB : UPDATE subjects...
    DB --> Repo : Success
    deactivate Repo
else New
    Handler -> Repo : AddAsync(NewSubject)
    activate Repo
    Repo -> DB : INSERT INTO subjects...
    DB --> Repo : Success
    deactivate Repo
end

Handler --> Med : CreateSubjectResponse
deactivate Handler

Med --> Controller : Response
deactivate Med

Controller --> Admin : 200 OK
deactivate Controller
@enduml