@startuml
actor Student
participant ":UsersController" as Controller
participant ":IMediator" as Med
participant ":ProcessAcademicRecord\nHandler" as Handler
participant ":IHtmlCleaningService" as Cleaner
participant ":ICurriculumImportStorage" as Cache
participant ":IFapExtractionPlugin" as AIPlugin
participant ":ISubjectRepository" as SubRepo
participant ":IStudentSemesterSubject\nRepository" as GradeRepo
participant ":ISubjectSkillMapping\nRepository" as MappingRepo
participant ":IGradeExperienceCalculator" as Calc
database ":Database" as DB

Student -> Controller : Upload Transcript (HTML)
activate Controller

Controller -> Med : Send(ProcessAcademicRecordCommand)
activate Med

Med -> Handler : Handle(command)
activate Handler

' 1. Clean & Parse
Handler -> Handler : Validate HTML Structure
Handler -> Cleaner : ExtractCleanTextFromHtml(Html)
activate Cleaner
Cleaner --> Handler : CleanText
deactivate Cleaner

Handler -> Handler : Compute Hash(RawText)
Handler -> Cache : TryGetByHashJsonAsync(Hash)
activate Cache
Cache --> Handler : CachedJson?
deactivate Cache

alt Cache Miss
    Handler -> AIPlugin : ExtractFapRecordJsonAsync(CleanText)
    activate AIPlugin
    note right: Calls Gemini to parse table
    AIPlugin --> Handler : FapRecordData (JSON)
    deactivate AIPlugin
    Handler -> Cache : SaveLatestAsync(Json, Hash)
end

' 2. Process Subjects
Handler -> SubRepo : GetAllAsync()
activate SubRepo
SubRepo -> DB : SELECT * FROM subjects...
DB --> SubRepo : SubjectCatalog
deactivate SubRepo
SubRepo --> Handler : SubjectCatalog
deactivate SubRepo

Handler -> GradeRepo : FindAsync(AuthUserId)
activate GradeRepo
GradeRepo -> DB : SELECT * FROM student_semester_subjects...
DB --> GradeRepo : ExistingGrades
deactivate GradeRepo
GradeRepo --> Handler : ExistingGrades
deactivate GradeRepo

loop For Each Extracted Subject
    Handler -> Handler : Map Status (Passed/Failed)
    
    alt Exists
        Handler -> GradeRepo : UpdateAsync(UpdatedRecord)
    else New
        Handler -> GradeRepo : AddAsync(NewRecord)
    end
end

' 3. Award XP
Handler -> MappingRepo : GetMappingsBySubjectIdsAsync(PassedIds)
activate MappingRepo
MappingRepo -> DB : SELECT * FROM subject_skill_mappings...
DB --> MappingRepo : SkillMappings
deactivate MappingRepo
MappingRepo --> Handler : SkillMappings
deactivate MappingRepo

loop For Each Passed Subject
    loop For Each Mapped Skill
        Handler -> Calc : CalculateXpAward(Grade, Semester, Weight)
        activate Calc
        Calc --> Handler : Points
        deactivate Calc
        
        Handler -> Med : Send(IngestXpEventCommand)
        note right
            Awards XP to user skill
            Idempotent based on SubjectId
        end note
    end
end

' 4. Trigger Quest Generation
Handler -> Med : Send(GenerateQuestLineCommand)

Handler --> Med : ProcessAcademicRecordResponse
deactivate Handler

Med --> Controller : Response
deactivate Med

Controller --> Student : 200 OK
deactivate Controller
@enduml