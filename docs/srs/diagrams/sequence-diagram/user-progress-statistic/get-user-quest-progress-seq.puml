@startuml
actor User
participant QuestManagementUI as UI
participant ":UserQuestProgress\nController" as Controller
participant ":IMediator" as Med
participant ":GetQuestProgress\nQueryHandler" as Handler
participant ":IUserQuestAttempt\nRepository" as IAttemptRepo
participant ":UserQuestAttempt\nRepository" as AttemptRepo
participant ":IQuestStep\nRepository" as IStepRepo
participant ":QuestStep\nRepository" as StepRepo
participant ":IUserQuestStepProgress\nRepository" as IProgressRepo
participant ":UserQuestStepProgress\nRepository" as ProgressRepo
database ":Database" as DB

User -> UI : Open Quest Map / Resume Quest
activate UI

UI -> Controller : GET /api/user-progress/quests/{id}
activate Controller

Controller -> Med : Send(GetQuestProgressQuery)
activate Med

Med -> Handler : Handle(query)
activate Handler

' 1. Get Attempt (Source of Truth for Difficulty)
Handler -> IAttemptRepo : FirstOrDefaultAsync(UserId, QuestId)
activate IAttemptRepo
IAttemptRepo -> AttemptRepo : FirstOrDefaultAsync(UserId, QuestId)
activate AttemptRepo
AttemptRepo -> DB : SELECT * FROM user_quest_attempts...
activate DB
DB --> AttemptRepo : Attempt
deactivate DB
AttemptRepo --> IAttemptRepo : Attempt
deactivate AttemptRepo
IAttemptRepo --> Handler : Attempt
deactivate IAttemptRepo

alt Attempt Not Found
    Handler --> Med : Throw NotFoundException
else Attempt Found
    ' 2. Get All Master Steps for Quest
    Handler -> IStepRepo : GetByQuestIdAsync(QuestId)
    activate IStepRepo
    IStepRepo -> StepRepo : GetByQuestIdAsync(QuestId)
    activate StepRepo
    StepRepo -> DB : SELECT * FROM quest_steps...
    activate DB
    DB --> StepRepo : AllSteps
    deactivate DB
    StepRepo --> IStepRepo : AllSteps
    deactivate StepRepo
    IStepRepo --> Handler : AllSteps
    deactivate IStepRepo

    ' 3. Filter Steps by Assigned Difficulty (In-Memory)
    Handler -> Handler : Filter Steps by Attempt.AssignedDifficulty
    note right
        e.g. Keep only "Standard" steps
    end note

    ' 4. Get Existing Progress Records
    Handler -> IProgressRepo : GetByAttemptIdAsync(AttemptId)
    activate IProgressRepo
    IProgressRepo -> ProgressRepo : GetByAttemptIdAsync(AttemptId)
    activate ProgressRepo
    ProgressRepo -> DB : SELECT * FROM user_quest_step_progress...
    activate DB
    DB --> ProgressRepo : ProgressList
    deactivate DB
    ProgressRepo --> IProgressRepo : ProgressList
    deactivate ProgressRepo
    IProgressRepo --> Handler : ProgressList
    deactivate IProgressRepo

    ' 5. Merge & Calculate Lock State
    loop For Each Step in Track
        Handler -> Handler : Match Step to Progress Record
        Handler -> Handler : Calculate IsLocked
        note right
            Locked if previous step is NOT completed
        end note
    end

    Handler --> Med : List<QuestStepProgressDto>
end

deactivate Handler

Med --> Controller : Response
deactivate Med

Controller --> UI : 200 OK (Quest Map Data)
deactivate Controller

UI -> UI : Render Steps & Lock Status
UI --> User : Display Progress Map
deactivate UI
@enduml