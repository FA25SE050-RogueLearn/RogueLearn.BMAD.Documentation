@startuml
actor Admin
participant AdminManagementUI as UI
participant ":QuestFeedback\nController" as Controller
participant ":IMediator" as Med
participant ":ResolveQuestStepFeedback\nCommandHandler" as Handler
participant ":IUserQuestStepFeedback\nRepository" as IRepo
participant ":UserQuestStepFeedback\nRepository" as Repo
database ":Database" as DB

Admin -> UI : Mark Feedback as Resolved / Add Notes
activate UI

UI -> Controller : PATCH /admin/quests/feedback/{id}
activate Controller

Controller -> Med : Send(ResolveQuestStepFeedbackCommand)
activate Med

Med -> Handler : Handle(Command)
activate Handler

' 1. Fetch Feedback
Handler -> IRepo : GetByIdAsync(FeedbackId)
activate IRepo
IRepo -> Repo : GetByIdAsync(FeedbackId)
activate Repo
Repo -> DB : SELECT * FROM user_quest_step_feedback WHERE id = ...
activate DB
DB --> Repo : Feedback Entity
deactivate DB
Repo --> IRepo : Feedback Entity
deactivate Repo
IRepo --> Handler : Feedback Entity
deactivate IRepo

alt Feedback Not Found
    Handler --> Med : Throw NotFoundException
    deactivate Handler
    Med --> Controller : 404 Not Found
    deactivate Med
    Controller --> UI : 404 Not Found
    UI --> Admin : Show Error Toast
else Feedback Found
    ' 2. Update State
    activate Handler
    Handler -> Handler : Update Properties
    note right
        IsResolved = true/false
        AdminNotes = "Fixed typo..."
        UpdatedAt = UtcNow
    end note

    ' 3. Persist
    Handler -> IRepo : UpdateAsync(Entity)
    activate IRepo
    IRepo -> Repo : UpdateAsync(Entity)
    activate Repo
    Repo -> DB : UPDATE user_quest_step_feedback...
    activate DB
    DB --> Repo : Success
    deactivate DB
    Repo --> IRepo : Success
    deactivate Repo
    IRepo --> Handler : Success
    deactivate IRepo
    
    Handler --> Med : Unit.Value
    deactivate Handler
    
    Med --> Controller : Result
    deactivate Med

    Controller --> UI : 204 No Content
    deactivate Controller

    UI -> UI : Gray out Resolved Item
    UI --> Admin : Show "Feedback Resolved" Confirmation
end
deactivate UI
@enduml