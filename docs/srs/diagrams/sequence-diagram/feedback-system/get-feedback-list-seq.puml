@startuml
actor Admin
participant ":QuestFeedback\nController" as Controller
participant ":IMediator" as Med
participant ":GetQuestFeedbackList\nQueryHandler" as Handler
participant ":IUserQuestStepFeedback\nRepository" as IRepo
participant ":UserQuestStepFeedback\nRepository" as Repo
database ":Database" as DB

Admin -> Controller : GET /admin/quests/feedback?subjectId=...
activate Controller

Controller -> Med : Send(GetQuestFeedbackListQuery)
activate Med

Med -> Handler : Handle(Query)
activate Handler

alt SubjectId Provided
    ' Admin viewing aggregated issues for a specific subject
    Handler -> IRepo : GetBySubjectIdAsync(SubjectId)
    activate IRepo
    IRepo -> Repo : GetBySubjectIdAsync(SubjectId)
    activate Repo
    Repo -> DB : SELECT * FROM user_quest_step_feedback WHERE subject_id = ...
    activate DB
    DB --> Repo : List<Feedback>
    deactivate DB
    Repo --> IRepo : List<Feedback>
    deactivate Repo
    IRepo --> Handler : List<Feedback>
    deactivate IRepo

else QuestId Provided
    ' Admin investigating a specific user's quest history
    Handler -> IRepo : GetByQuestIdAsync(QuestId)
    activate IRepo
    IRepo -> Repo : GetByQuestIdAsync(QuestId)
    activate Repo
    Repo -> DB : SELECT * FROM user_quest_step_feedback WHERE quest_id = ...
    activate DB
    DB --> Repo : List<Feedback>
    deactivate DB
    Repo --> IRepo : List<Feedback>
    deactivate Repo
    IRepo --> Handler : List<Feedback>
    deactivate IRepo

else Unresolved Only (Default Triage)
    ' Admin viewing global triage list
    Handler -> IRepo : GetUnresolvedAsync()
    activate IRepo
    IRepo -> Repo : GetUnresolvedAsync()
    activate Repo
    Repo -> DB : SELECT * FROM user_quest_step_feedback WHERE is_resolved = false
    activate DB
    DB --> Repo : List<Feedback>
    deactivate DB
    Repo --> IRepo : List<Feedback>
    deactivate Repo
    IRepo --> Handler : List<Feedback>
    deactivate IRepo

else Fallback
    Handler -> IRepo : GetAllAsync()
    activate IRepo
    IRepo -> Repo : GetAllAsync()
    activate Repo
    Repo -> DB : SELECT * FROM user_quest_step_feedback...
    activate DB
    DB --> Repo : List<Feedback>
    deactivate DB
    Repo --> IRepo : List<Feedback>
    deactivate Repo
    IRepo --> Handler : List<Feedback>
    deactivate IRepo
end

' In-Memory Filter application (if specific Repo method didn't filter unresolved)
opt UnresolvedOnly && (SubjectId or QuestId set)
    Handler -> Handler : Filter where !IsResolved
end

Handler -> Handler : Map to DTOs

Handler --> Med : List<QuestFeedbackDto>
deactivate Handler

Med --> Controller : Response
deactivate Med

Controller --> Admin : 200 OK
deactivate Controller
@enduml